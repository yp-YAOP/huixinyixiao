<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <!-- é˜²æ­¢ç¼“å­˜çš„metaæ ‡ç­¾ -->
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
    <meta http-equiv="Pragma" content="no-cache" />
    <meta http-equiv="Expires" content="0" />
    <!-- ç‰ˆæœ¬å·ç”¨äºç¼“å­˜æ§åˆ¶ -->
    <meta name="version" content="2.0.1" />
    <title>æ…§å¿ƒä¸€å­ - åŒ»æŠ¤å·¥ä½œç«™</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    
    <!-- å…¨å±€é”™è¯¯å¤„ç†å’Œæµè§ˆå™¨å…¼å®¹æ€§è„šæœ¬ -->
    <script>
      // å…¨å±€é”™è¯¯å¤„ç†
      window.addEventListener('error', function(e) {
        console.error('âŒ å…¨å±€JavaScripté”™è¯¯:', e.error);
        console.error('é”™è¯¯ä½ç½®:', e.filename + ':' + e.lineno + ':' + e.colno);
        
        // å¦‚æœæ˜¯è¿æ¥ç›¸å…³çš„é”™è¯¯ï¼Œæ˜¾ç¤ºå‹å¥½æç¤º
        if (e.error && e.error.message && e.error.message.includes('EventSource')) {
          setTimeout(() => {
            alert('ç½‘ç»œè¿æ¥æ¨¡å—å‡ºç°é—®é¢˜ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•\n\nå»ºè®®ï¼š\n1. æŒ‰ Ctrl+F5 å¼ºåˆ¶åˆ·æ–°\n2. æ¸…é™¤æµè§ˆå™¨ç¼“å­˜\n3. é‡å¯æµè§ˆå™¨');
          }, 1000);
        }
      });
      
      // æœªå¤„ç†çš„Promiseæ‹’ç»
      window.addEventListener('unhandledrejection', function(e) {
        console.error('âŒ æœªå¤„ç†çš„Promiseæ‹’ç»:', e.reason);
        e.preventDefault(); // é˜²æ­¢åœ¨æ§åˆ¶å°æ˜¾ç¤º
      });
      
      // æ£€æµ‹æµè§ˆå™¨å…¼å®¹æ€§
      (function() {
        const isEdge = navigator.userAgent.includes('Edg/');
        const isChrome = navigator.userAgent.includes('Chrome/');
        const isFirefox = navigator.userAgent.includes('Firefox/');
        
        console.log('ğŸŒ æµè§ˆå™¨æ£€æµ‹:', {
          userAgent: navigator.userAgent,
          isEdge,
          isChrome,
          isFirefox,
          eventSourceSupport: typeof EventSource !== 'undefined',
          fetchSupport: typeof fetch !== 'undefined'
        });
        
        // ä¸ºEdgeæµè§ˆå™¨æ·»åŠ ç‰¹æ®Šå¤„ç†
        if (isEdge) {
          console.log('ğŸ”§ Edgeæµè§ˆå™¨æ£€æµ‹åˆ°ï¼Œåº”ç”¨å…¼å®¹æ€§ä¿®å¤...');
          // Edgeæµè§ˆå™¨çš„ç‰¹æ®Šå¤„ç†
          window.edgeBrowser = true;
        }
      })();
    </script>

    <script>
      tailwind.config = {
        theme: {
          extend: {
            fontFamily: {
              apple: [
                "-apple-system",
                "BlinkMacSystemFont",
                "Inter",
                "sans-serif",
              ],
            },
            colors: {
              "apple-blue": "#007AFF",
              "apple-gray-1": "#F2F2F7",
              "apple-gray-2": "#E5E5EA",
              "apple-gray-3": "#D1D1D6",
              "apple-gray-4": "#C7C7CC",
              "apple-gray-5": "#AEAEB2",
              "apple-gray-6": "#8E8E93",
              "apple-green": "#34C759",
              "apple-orange": "#FF9500",
              "apple-red": "#FF3B30",
            },
            spacing: {
              18: "4.5rem",
              22: "5.5rem",
            },
            animation: {
              "fade-in": "fadeIn 0.6s ease-out",
              "slide-in": "slideIn 0.4s ease-out",
              "pulse-gentle": "pulseGentle 2s infinite",
            },
            backdropBlur: {
              xs: "2px",
            },
          },
        },
      };
    </script>

    <style>
      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      @keyframes slideIn {
        from {
          opacity: 0;
          transform: translateX(20px);
        }
        to {
          opacity: 1;
          transform: translateX(0);
        }
      }

      @keyframes pulseGentle {
        0%,
        100% {
          opacity: 1;
        }
        50% {
          opacity: 0.7;
        }
      }

      .glass-effect {
        background: rgba(255, 255, 255, 0.8);
        backdrop-filter: blur(20px);
        -webkit-backdrop-filter: blur(20px);
      }

      .card-apple {
        background: rgba(255, 255, 255, 0.9);
        border: 1px solid rgba(0, 0, 0, 0.05);
        box-shadow: 0 4px 16px rgba(0, 0, 0, 0.06),
          0 1px 4px rgba(0, 0, 0, 0.04);
      }

      .status-indicator {
        width: 8px;
        height: 8px;
        border-radius: 50%;
        display: inline-block;
      }

      .status-idle {
        background-color: #8e8e93;
      }
      .status-training {
        background-color: #34c759;
        animation: pulseGentle 2s infinite;
      }

      .patient-item {
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      }

      .patient-item:hover {
        transform: translateX(4px);
        background-color: rgba(247, 247, 247, 0.8);
      }

      .patient-item.active {
        background: linear-gradient(135deg, #007aff 0%, #0056cc 100%);
        color: white;
        transform: translateX(8px);
      }

      .patient-item.active .status-indicator {
        box-shadow: 0 0 0 2px rgba(255, 255, 255, 0.3);
      }

      .kpi-card {
        background: linear-gradient(
          135deg,
          rgba(0, 122, 255, 0.02) 0%,
          rgba(0, 122, 255, 0.05) 100%
        );
        border: 1px solid rgba(0, 122, 255, 0.1);
      }

      .notification-card {
        background: rgba(255, 255, 255, 0.95);
        border-left: 3px solid #ff9500;
        animation: slideIn 0.4s ease-out;
      }

      .button-apple {
        background: linear-gradient(135deg, #007aff 0%, #0056cc 100%);
        transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
      }

      .button-apple:hover {
        transform: translateY(-1px);
        box-shadow: 0 8px 25px rgba(0, 122, 255, 0.3);
      }

      .icon-button {
        transition: all 0.2s ease;
      }

      .icon-button:hover {
        transform: scale(1.1);
      }

      /* å¯è°ƒæ•´å¤§å°çš„ä¾§è¾¹æ æ ·å¼ */
      .resizable-sidebar {
        position: relative;
        transition: width 0.3s ease;
        min-width: 60px;
        max-width: 500px;
      }

      .resizable-sidebar.collapsed {
        width: 60px !important;
        cursor: pointer;
      }

      .resizable-sidebar.collapsed:hover {
        background: rgba(255, 255, 255, 0.8);
      }

      .resize-handle {
        position: absolute;
        top: 0;
        width: 4px;
        height: 100%;
        background: transparent;
        cursor: col-resize;
        z-index: 10;
        transition: background-color 0.2s ease;
      }

      .resize-handle:hover {
        background-color: rgba(0, 122, 255, 0.3);
      }

      .resize-handle.active {
        background-color: rgba(0, 122, 255, 0.5);
      }

      .resize-handle.left {
        right: 0;
      }

      .resize-handle.right {
        left: 0;
      }

      .sidebar-header {
        position: relative;
        display: flex;
        align-items: center;
        justify-content: space-between;
      }

      .collapse-btn {
        width: 28px;
        height: 28px;
        border-radius: 8px;
        background: rgba(0, 122, 255, 0.1);
        border: none;
        color: #007aff;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.2s ease;
        flex-shrink: 0;
      }

      .collapse-btn:hover {
        background: rgba(0, 122, 255, 0.2);
        transform: scale(1.1);
      }

      .sidebar-content {
        overflow: hidden;
        transition: opacity 0.2s ease;
      }

      .resizable-sidebar.collapsed .sidebar-content {
        opacity: 0;
        pointer-events: none;
      }

      .resizable-sidebar.collapsed .sidebar-header h2 {
        opacity: 0;
      }

      .resizable-sidebar.collapsed .sidebar-header > div:first-child {
        opacity: 0;
      }

      /* ç¡®ä¿æŠ˜å æŒ‰é’®åœ¨æŠ˜å çŠ¶æ€ä¸‹ä»ç„¶å¯è§å’Œå¯ç‚¹å‡» */
      .resizable-sidebar.collapsed .collapse-btn {
        opacity: 1 !important;
        pointer-events: auto !important;
        position: absolute;
        top: 8px;
        left: 50%;
        transform: translateX(-50%);
        z-index: 100;
        background: rgba(0, 122, 255, 0.15) !important;
        box-shadow: 0 2px 8px rgba(0, 122, 255, 0.2);
        width: 24px;
        height: 24px;
      }

      .resizable-sidebar.collapsed .collapse-btn:hover {
        background: rgba(0, 122, 255, 0.25) !important;
        transform: translateX(-50%) scale(1.05);
      }

      .collapsed-indicator {
        position: absolute;
        top: 50px;
        left: 50%;
        transform: translate(-50%, 0) rotate(-90deg);
        font-size: 10px;
        font-weight: 600;
        color: #007aff;
        white-space: nowrap;
        opacity: 0;
        transition: opacity 0.2s ease;
        cursor: pointer;
        user-select: none;
        transform-origin: center;
      }

      .resizable-sidebar.collapsed .collapsed-indicator {
        opacity: 0.7;
      }

      .resizable-sidebar.collapsed:hover .collapsed-indicator {
        opacity: 1;
      }

      /* æ·»åŠ å±•å¼€æç¤º */
      .expand-hint {
        position: absolute;
        bottom: 15px;
        left: 50%;
        transform: translateX(-50%);
        font-size: 8px;
        color: #007aff;
        opacity: 0;
        transition: opacity 0.2s ease;
        text-align: center;
        cursor: pointer;
        user-select: none;
        line-height: 1.1;
        width: 36px;
      }

      .resizable-sidebar.collapsed .expand-hint {
        opacity: 0.4;
      }

      .resizable-sidebar.collapsed:hover .expand-hint {
        opacity: 0.7;
      }

      /* æŠ˜å çŠ¶æ€ä¸‹çš„ç‰¹æ®Šå¸ƒå±€ */
      .resizable-sidebar.collapsed .sidebar-header {
        position: relative;
        height: 100vh;
      }

      /* æŠ½å±‰æ ·å¼ */
      .drawer {
        max-height: 0;
        overflow: hidden;
        transition: max-height 0.3s ease-out;
      }

      .drawer.open {
        max-height: 200px;
      }

      .drawer-toggle {
        cursor: pointer;
        transition: transform 0.3s ease;
      }

      .drawer-toggle.open {
        transform: rotate(180deg);
      }

      .game-detail-item {
        padding: 8px 12px;
        margin: 4px 0;
        background: rgba(255, 255, 255, 0.5);
        border-radius: 8px;
        font-size: 0.875rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .game-detail-item .game-name {
        font-weight: 500;
        color: #374151;
      }

      .game-detail-item .game-value {
        font-weight: 600;
        color: #111827;
      }
    </style>
  </head>

  <body class="bg-apple-gray-1 font-apple antialiased">
    <!-- é¡¶éƒ¨å¯¼èˆªæ  -->
    <nav class="glass-effect border-b border-apple-gray-3/30 sticky top-0 z-50">
      <div class="px-8 py-4">
        <div class="flex items-center justify-between">
          <div class="flex items-center space-x-4">
            <div
              class="w-10 h-10 bg-gradient-to-br from-apple-blue to-blue-600 rounded-xl flex items-center justify-center shadow-lg"
            >
              <i data-lucide="heart-pulse" class="text-white w-5 h-5"></i>
            </div>
            <div>
              <h1 class="text-xl font-semibold text-gray-900 tracking-tight">
                æ…§å¿ƒä¸€å­
              </h1>
              <p class="text-sm text-apple-gray-6 font-medium">åŒ»æŠ¤å·¥ä½œç«™</p>
            </div>
          </div>

          <!-- å³ä¾§ç”¨æˆ·ä¿¡æ¯ -->
          <div class="flex items-center space-x-4">
            <!-- ç½‘ç»œçŠ¶æ€ -->
            <div class="flex items-center space-x-2 px-3 py-2 bg-white/50 rounded-lg border">
              <div id="network-status" class="status-indicator status-idle"></div>
              <span id="network-text" class="text-xs text-apple-gray-6 font-medium">æœªè¿æ¥</span>
              <button
                id="network-settings-btn"
                class="icon-button p-1 rounded hover:bg-apple-gray-2/50"
                title="ç½‘ç»œè®¾ç½®"
                onclick="toggleNetworkSettings()"
              >
                <i data-lucide="settings" class="w-3 h-3 text-apple-gray-6"></i>
              </button>
            </div>
            
            <div class="hidden md:flex items-center space-x-3">
              <div class="text-right">
                <p class="text-sm font-semibold text-gray-900">é™ˆåŒ»ç”Ÿ</p>
                <p class="text-xs text-apple-gray-6">åº·å¤ç§‘ä¸»ä»»</p>
              </div>
              <div
                class="w-10 h-10 bg-gradient-to-br from-apple-gray-4 to-apple-gray-5 rounded-full flex items-center justify-center"
              >
                <i data-lucide="user" class="text-white w-5 h-5"></i>
              </div>
            </div>

            <!-- é€šçŸ¥å›¾æ ‡ -->
            <button
              class="icon-button relative p-2 rounded-lg hover:bg-apple-gray-2/50"
            >
              <i data-lucide="bell" class="w-5 h-5 text-apple-gray-6"></i>
              <span
                class="absolute -top-1 -right-1 w-3 h-3 bg-apple-red rounded-full"
              ></span>
            </button>
          </div>
        </div>
      </div>
    </nav>

    <div class="flex h-screen">
      <!-- å·¦ä¾§è¾¹æ ï¼šæ‚£è€…åˆ—è¡¨ -->
      <div
        id="patient-sidebar"
        class="resizable-sidebar w-80 bg-white/70 backdrop-blur-sm border-r border-apple-gray-3/30 overflow-y-auto"
      >
        <!-- æ‹–æ‹½è°ƒæ•´å¤§å°çš„æ§åˆ¶æ¡ -->
        <div class="resize-handle left" id="patient-resize-handle"></div>

        <div class="p-6">
          <div class="sidebar-header mb-6">
            <h2 class="text-lg font-semibold text-gray-900 tracking-tight">
              æˆ‘çš„æ‚£è€…
            </h2>
            <div class="flex items-center space-x-2">
              <span
                id="patient-count"
                class="bg-apple-blue/10 text-apple-blue text-xs font-medium px-3 py-1 rounded-full"
              >
                åŠ è½½ä¸­...
              </span>
              <button
                class="collapse-btn"
                id="patient-collapse-btn"
                title="æ”¶èµ·/å±•å¼€"
              >
                <i data-lucide="chevron-left" class="w-4 h-4"></i>
              </button>
            </div>
            <div class="collapsed-indicator">æˆ‘çš„æ‚£è€…</div>
            <div class="expand-hint">ç‚¹å‡»<br />å±•å¼€</div>
          </div>

          <div class="sidebar-content">
            <!-- æœç´¢æ¡† -->
            <div class="mb-6">
              <div class="relative">
                <i
                  data-lucide="search"
                  class="absolute left-3 top-1/2 transform -translate-y-1/2 w-4 h-4 text-apple-gray-6"
                ></i>
                <input
                  type="text"
                  placeholder="æœç´¢æ‚£è€…..."
                  class="w-full pl-10 pr-4 py-3 bg-apple-gray-1 border border-apple-gray-3 rounded-xl text-sm focus:outline-none focus:ring-2 focus:ring-apple-blue/20 focus:border-apple-blue transition-all duration-200"
                />
              </div>
            </div>

            <div class="space-y-2" id="patient-list">
              <!-- æ‚£è€…åˆ—è¡¨é¡¹å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
            </div>
          </div>
        </div>
      </div>

      <!-- ä¸»å†…å®¹åŒºï¼šæ‚£è€…è¯¦æƒ…ä»ªè¡¨ç›˜ -->
      <div
        class="flex-1 overflow-y-auto bg-gradient-to-br from-white/50 to-apple-gray-1/50"
      >
        <div class="p-8">
          <!-- é»˜è®¤æç¤ºä¿¡æ¯ -->
          <div id="default-view" class="text-center py-20 animate-fade-in">
            <div
              class="w-24 h-24 bg-gradient-to-br from-apple-blue/10 to-apple-blue/20 rounded-full flex items-center justify-center mx-auto mb-6"
            >
              <i
                data-lucide="stethoscope"
                class="w-12 h-12 text-apple-blue"
              ></i>
            </div>
            <h3
              class="text-2xl font-semibold text-gray-900 mb-3 tracking-tight"
            >
              æ¬¢è¿ä½¿ç”¨åŒ»æŠ¤å·¥ä½œç«™
            </h3>
            <p class="text-apple-gray-6 text-lg">
              è¯·ä»å·¦ä¾§é€‰æ‹©ä¸€ä½æ‚£è€…æŸ¥çœ‹è¯¦ç»†ä¿¡æ¯
            </p>
          </div>

          <!-- æ‚£è€…è¯¦æƒ…å†…å®¹ -->
          <div id="patient-detail" class="hidden animate-fade-in">
            <!-- æ‚£è€…åŸºæœ¬ä¿¡æ¯å¡ç‰‡ -->
            <div class="card-apple rounded-2xl p-8 mb-8">
              <div class="flex items-center space-x-6">
                <div
                  class="w-20 h-20 bg-gradient-to-br from-apple-blue/10 to-apple-blue/20 rounded-2xl flex items-center justify-center"
                >
                  <i data-lucide="user" class="text-apple-blue w-8 h-8"></i>
                </div>
                <div class="flex-1">
                  <h2
                    id="patient-name"
                    class="text-3xl font-bold text-gray-900 mb-2 tracking-tight"
                  >
                    æ‚£è€…å§“å
                  </h2>
                  <div class="grid grid-cols-1 md:grid-cols-3 gap-4 text-sm">
                    <div class="flex items-center space-x-2">
                      <i
                        data-lucide="calendar"
                        class="w-4 h-4 text-apple-gray-6"
                      ></i>
                      <span class="text-apple-gray-6">å¹´é¾„ï¼š</span>
                      <span id="patient-age" class="font-medium text-gray-900"
                        >--</span
                      >
                    </div>
                    <div class="flex items-center space-x-2">
                      <i
                        data-lucide="activity"
                        class="w-4 h-4 text-apple-gray-6"
                      ></i>
                      <span class="text-apple-gray-6">é˜¶æ®µï¼š</span>
                      <span id="patient-stage" class="font-medium text-gray-900"
                        >--</span
                      >
                    </div>
                    <div class="flex items-center space-x-2">
                      <i
                        data-lucide="clipboard-list"
                        class="w-4 h-4 text-apple-gray-6"
                      ></i>
                      <span class="text-apple-gray-6">è¯Šæ–­ï¼š</span>
                      <span
                        id="patient-diagnosis"
                        class="font-medium text-gray-900"
                        >--</span
                      >
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- KPI æ¦‚è§ˆå¡ç‰‡ç½‘æ ¼ -->
            <div
              class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8"
            >
              <div class="kpi-card rounded-2xl p-6">
                <div class="flex items-center justify-between">
                  <div>
                    <p class="text-sm font-medium text-apple-gray-6 mb-1">
                      ç´¯è®¡è®­ç»ƒæ—¶é•¿
                    </p>
                    <p
                      id="total-duration"
                      class="text-2xl font-bold text-gray-900 tracking-tight"
                    >
                      --
                    </p>
                  </div>
                  <div class="flex items-center space-x-2">
                    <div
                      class="w-12 h-12 bg-apple-blue/10 rounded-xl flex items-center justify-center"
                    >
                      <i data-lucide="clock" class="w-6 h-6 text-apple-blue"></i>
                    </div>
                    <button
                      class="drawer-toggle w-6 h-6 flex items-center justify-center text-apple-gray-6 hover:text-apple-blue"
                      onclick="toggleDrawer('duration-drawer')"
                    >
                      <i data-lucide="chevron-down" class="w-4 h-4"></i>
                    </button>
                  </div>
                </div>
                <!-- è®­ç»ƒæ—¶é•¿è¯¦ç»†æŠ½å±‰ -->
                <div id="duration-drawer" class="drawer mt-4">
                  <div class="space-y-2">
                    <div class="game-detail-item">
                      <span class="game-name">ååº”é€Ÿåº¦è®­ç»ƒ</span>
                      <span id="fruit-duration" class="game-value">--</span>
                    </div>
                    <div class="game-detail-item">
                      <span class="game-name">è®¤çŸ¥èƒ½åŠ›è®­ç»ƒ</span>
                      <span id="number-duration" class="game-value">--</span>
                    </div>
                    <div class="game-detail-item">
                      <span class="game-name">æ‰‹çœ¼åè°ƒè®­ç»ƒ</span>
                      <span id="hand-duration" class="game-value">--</span>
                    </div>
                  </div>
                </div>
              </div>

              <div class="kpi-card rounded-2xl p-6">
                <div class="flex items-center justify-between">
                  <div>
                    <p class="text-sm font-medium text-apple-gray-6 mb-1">
                      å¹³å‡æ ‡å‡†ç‡
                    </p>
                    <p
                      id="avg-accuracy"
                      class="text-2xl font-bold text-gray-900 tracking-tight"
                    >
                      --
                    </p>
                  </div>
                  <div
                    class="w-12 h-12 bg-apple-green/10 rounded-xl flex items-center justify-center"
                  >
                    <i
                      data-lucide="target"
                      class="w-6 h-6 text-apple-green"
                    ></i>
                  </div>
                </div>
              </div>

              <div class="kpi-card rounded-2xl p-6">
                <div class="flex items-center justify-between">
                  <div>
                    <p class="text-sm font-medium text-apple-gray-6 mb-1">
                      æœ¬å‘¨å¾—åˆ†
                    </p>
                    <p
                      id="week-score"
                      class="text-2xl font-bold text-gray-900 tracking-tight"
                    >
                      --
                    </p>
                  </div>
                  <div class="flex items-center space-x-2">
                    <div
                      class="w-12 h-12 bg-yellow-500/10 rounded-xl flex items-center justify-center"
                    >
                      <i data-lucide="trophy" class="w-6 h-6 text-yellow-600"></i>
                    </div>
                    <button
                      class="drawer-toggle w-6 h-6 flex items-center justify-center text-apple-gray-6 hover:text-apple-blue"
                      onclick="toggleDrawer('score-drawer')"
                    >
                      <i data-lucide="chevron-down" class="w-4 h-4"></i>
                    </button>
                  </div>
                </div>
                <!-- æœ¬å‘¨å¾—åˆ†è¯¦ç»†æŠ½å±‰ -->
                <div id="score-drawer" class="drawer mt-4">
                  <div class="space-y-2">
                    <div class="game-detail-item">
                      <span class="game-name">ååº”é€Ÿåº¦è®­ç»ƒ</span>
                      <span id="fruit-score" class="game-value">--</span>
                    </div>
                    <div class="game-detail-item">
                      <span class="game-name">è®¤çŸ¥èƒ½åŠ›è®­ç»ƒ</span>
                      <span id="number-score" class="game-value">--</span>
                    </div>
                    <div class="game-detail-item">
                      <span class="game-name">æ‰‹çœ¼åè°ƒè®­ç»ƒ</span>
                      <span id="hand-score" class="game-value">--</span>
                    </div>
                  </div>
                </div>
              </div>

              <div class="kpi-card rounded-2xl p-6">
                <div class="flex items-center justify-between">
                  <div>
                    <p class="text-sm font-medium text-apple-gray-6 mb-1">
                      åº·å¤è¿›åº¦
                    </p>
                    <p
                      id="progress-rate"
                      class="text-2xl font-bold text-gray-900 tracking-tight"
                    >
                      --
                    </p>
                  </div>
                  <div
                    class="w-12 h-12 bg-purple-500/10 rounded-xl flex items-center justify-center"
                  >
                    <i
                      data-lucide="trending-up"
                      class="w-6 h-6 text-purple-600"
                    ></i>
                  </div>
                </div>
              </div>
            </div>

            <!-- åº·å¤è¿›åº¦ä¸èƒ½åŠ›é˜¶æ®µå›¾è¡¨ -->
            <div class="card-apple rounded-2xl p-8 mb-8">
              <div class="flex items-center justify-between mb-6">
                <h3 class="text-xl font-semibold text-gray-900 tracking-tight">
                  <i
                    data-lucide="trending-up"
                    class="inline w-5 h-5 mr-2 text-apple-blue"
                  ></i>
                  åº·å¤è¿›åº¦ä¸åŠŸèƒ½èƒ½åŠ›
                </h3>
                <div class="flex space-x-2">
                  <button
                    class="px-3 py-1 text-sm bg-apple-blue text-white rounded-lg font-medium"
                  >
                    7å¤©
                  </button>
                  <button
                    class="px-3 py-1 text-sm text-apple-gray-6 hover:bg-apple-gray-2 rounded-lg font-medium transition-colors"
                  >
                    3å¤©
                  </button>
                </div>
              </div>
              <div class="h-96">
                <canvas id="progress-chart"></canvas>
              </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
              <!-- è®­ç»ƒæ—¥å¿— -->
              <div class="card-apple rounded-2xl p-8">
                <h3
                  class="text-xl font-semibold text-gray-900 mb-6 tracking-tight"
                >
                  <i
                    data-lucide="list"
                    class="inline w-5 h-5 mr-2 text-apple-blue"
                  ></i>
                  è®­ç»ƒè®°å½•
                </h3>
                <div class="space-y-4" id="training-logs">
                  <!-- è®­ç»ƒè®°å½•å°†é€šè¿‡JavaScriptå¡«å…… -->
                </div>
              </div>

              <!-- AIé£é™©åˆ†æ -->
              <div class="card-apple rounded-2xl p-8">
                <h3
                  class="text-xl font-semibold text-gray-900 mb-6 tracking-tight"
                >
                  <i
                    data-lucide="brain"
                    class="inline w-5 h-5 mr-2 text-apple-blue"
                  ></i>
                  AIé£é™©åˆ†æ
                </h3>
                <div id="risk-analysis" class="space-y-4">
                  <!-- é£é™©åˆ†æé¡¹å°†é€šè¿‡JavaScriptå¡«å…… -->
                </div>
              </div>
            </div>

            <!-- åº·å¤è®¡åˆ’ç®¡ç† -->
            <div class="card-apple rounded-2xl p-8 mt-8">
              <h3
                class="text-xl font-semibold text-gray-900 mb-6 tracking-tight"
              >
                <i
                  data-lucide="calendar-check"
                  class="inline w-5 h-5 mr-2 text-apple-blue"
                ></i>
                åº·å¤è®¡åˆ’ç®¡ç†
              </h3>
              <div class="bg-apple-gray-1/50 rounded-xl p-6 mb-6">
                <p id="current-plan" class="text-gray-700 leading-relaxed">
                  å½“å‰åº·å¤è®¡åˆ’åŠ è½½ä¸­...
                </p>
              </div>
              <button
                class="button-apple text-white px-6 py-3 rounded-xl font-medium inline-flex items-center space-x-2"
              >
                <i data-lucide="edit" class="w-4 h-4"></i>
                <span>è°ƒæ•´è®¡åˆ’</span>
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- å³ä¾§è¾¹æ ï¼šå®æ—¶äº‹ä»¶ä¸é€šçŸ¥ -->
      <div
        id="notification-sidebar"
        class="resizable-sidebar w-80 bg-white/70 backdrop-blur-sm border-l border-apple-gray-3/30 overflow-y-auto"
      >
        <!-- æ‹–æ‹½è°ƒæ•´å¤§å°çš„æ§åˆ¶æ¡ -->
        <div class="resize-handle right" id="notification-resize-handle"></div>

        <div class="p-6">
          <div class="sidebar-header mb-6">
            <h2 class="text-lg font-semibold text-gray-900 tracking-tight">
              å®æ—¶é€šçŸ¥
            </h2>
            <div class="flex items-center space-x-2">
              <div class="flex items-center space-x-2">
                <div id="ws-status" class="status-indicator status-idle"></div>
                <span class="text-xs text-apple-gray-6 font-medium"
                  >è¿æ¥çŠ¶æ€</span
                >
              </div>
              <button
                class="collapse-btn"
                id="notification-collapse-btn"
                title="æ”¶èµ·/å±•å¼€"
              >
                <i data-lucide="chevron-right" class="w-4 h-4"></i>
              </button>
            </div>
            <div class="collapsed-indicator">å®æ—¶é€šçŸ¥</div>
            <div class="expand-hint">ç‚¹å‡»<br />å±•å¼€</div>
          </div>

          <div class="sidebar-content">
            <div id="notifications" class="space-y-4">
              <div class="text-center py-12">
                <div
                  class="w-16 h-16 bg-apple-gray-2 rounded-full flex items-center justify-center mx-auto mb-4"
                >
                  <i data-lucide="bell" class="w-8 h-8 text-apple-gray-5"></i>
                </div>
                <p class="text-apple-gray-6">æš‚æ— å®æ—¶äº‹ä»¶</p>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- ç½‘ç»œè®¾ç½®é¢æ¿ -->
    <div id="network-settings-panel" class="hidden fixed inset-0 bg-black/50 z-50 flex items-center justify-center">
      <div class="bg-white rounded-2xl p-8 max-w-md w-full mx-4 shadow-2xl">
        <div class="flex items-center justify-between mb-6">
          <h3 class="text-xl font-semibold text-gray-900">ç½‘ç»œè®¾ç½®</h3>
          <button
            onclick="toggleNetworkSettings()"
            class="icon-button p-2 rounded-lg hover:bg-apple-gray-2"
          >
            <i data-lucide="x" class="w-5 h-5 text-apple-gray-6"></i>
          </button>
        </div>
        
        <div class="space-y-4">
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">æœåŠ¡å™¨åœ°å€</label>
            <input
              id="server-url-input"
              type="text"
              placeholder="è‡ªåŠ¨æ£€æµ‹ä¸­..."
              class="w-full px-4 py-3 border border-apple-gray-3 rounded-xl focus:outline-none focus:ring-2 focus:ring-apple-blue/20 focus:border-apple-blue"
              value=""
              readonly
            />
            <p class="text-xs text-apple-gray-6 mt-1">ç³»ç»Ÿå°†è‡ªåŠ¨æ£€æµ‹å¹¶è¿æ¥åˆ°åŒä¸€å±€åŸŸç½‘å†…çš„æœåŠ¡å™¨</p>
          </div>
          
          <div class="flex items-center justify-between py-2">
            <div>
              <label class="text-sm font-medium text-gray-700">è‡ªåŠ¨åŒæ­¥</label>
              <p class="text-xs text-apple-gray-6">æ¯15ç§’è‡ªåŠ¨è·å–æœ€æ–°æ•°æ®</p>
            </div>
            <label class="relative inline-flex items-center cursor-pointer">
              <input id="auto-sync-toggle" type="checkbox" class="sr-only peer" checked>
              <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-apple-blue/20 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-apple-blue"></div>
            </label>
          </div>
          
          <div class="flex space-x-3">
            <button
              onclick="reDetectServer()"
              class="flex-1 px-4 py-3 bg-apple-gray-2 text-gray-700 rounded-xl font-medium hover:bg-apple-gray-3 transition-colors"
            >
              é‡æ–°æ£€æµ‹
            </button>
            <button
              onclick="connectToNetwork()"
              class="flex-1 button-apple text-white px-4 py-3 rounded-xl font-medium"
            >
              è¿æ¥
            </button>
          </div>
          
          <div id="network-status-info" class="p-3 bg-apple-gray-1 rounded-xl hidden">
            <div class="flex items-center space-x-2">
              <div id="connection-indicator" class="status-indicator status-idle"></div>
              <span id="connection-status-text" class="text-sm text-gray-700">ç­‰å¾…è¿æ¥...</span>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script>
      // åˆå§‹åŒ–Lucideå›¾æ ‡
      lucide.createIcons();

      // å…¨å±€å˜é‡
      let currentPatientId = null;
      let progressChart = null;
      let websocket = null;
      
      // ç½‘ç»œä¼ è¾“ç›¸å…³å˜é‡
      let networkConfig = {
        serverUrl: '',
        connected: false,
        eventSource: null,
        autoSync: true,
        syncInterval: 15000, // 15ç§’
        autoDetection: true
      };
      let networkSyncTimer = null;

      // æ¨¡æ‹Ÿæ•°æ®
      const mockPatients = [
        { id: 101, name: "ç‹å¤§çˆ·", age: 72, status: "idle" },
        { id: 102, name: "æé˜¿å§¨", age: 68, status: "training" },
        { id: 103, name: "å¼ å…ˆç”Ÿ", age: 65, status: "idle" },
        { id: 104, name: "é™ˆå¥¶å¥¶", age: 74, status: "idle" },
        { id: 105, name: "èµµå”å”", age: 69, status: "idle" },
      ];

      // åŠŸèƒ½èƒ½åŠ›é˜¶æ®µå®šä¹‰
      const capabilityThresholds = [
        { threshold: 20, capability: "åŸºç¡€æ„è¯†", color: "rgba(142, 142, 147, 0.8)" },
        { threshold: 30, capability: "è‚¢ä½“æ„ŸçŸ¥", color: "rgba(255, 45, 85, 0.8)" },
        { threshold: 40, capability: "ç®€å•åŠ¨ä½œ", color: "rgba(255, 59, 48, 0.8)" },
        { threshold: 50, capability: "åŸºç¡€æ„ŸçŸ¥", color: "rgba(255, 149, 0, 0.8)" },
        { threshold: 60, capability: "æ‰‹æŒ‡å¼¯æ›²", color: "rgba(255, 204, 0, 0.8)" },
        { threshold: 70, capability: "æŠ“æ¡èƒ½åŠ›", color: "rgba(52, 199, 89, 0.8)" },
        { threshold: 80, capability: "å¼€é—¨æŠŠæ‰‹", color: "rgba(30, 132, 255, 0.8)" },
        { threshold: 90, capability: "ç²¾ç»†æ“ä½œ", color: "rgba(0, 122, 255, 0.8)" },
        { threshold: 95, capability: "å¤æ‚åŠ¨ä½œ", color: "rgba(175, 82, 222, 0.8)" }
      ];

      const mockPatientReports = {
        101: {
          patientInfo: {
            id: 101,
            name: "ç‹å¤§çˆ·",
            age: 72,
            stage: "æ¢å¤ä¸­æœŸ",
            diagnosis: "å·¦ä¾§åç˜«",
          },
          overview: {
            totalDuration: "8å°æ—¶35åˆ†42ç§’",
            avgAccuracy: "92%",
            thisWeekScore: 850,
            scoreTrend: [75, 78, 82, 85, 83, 88, 91],
          },
          gameDetails: {
            fruit: { duration: "2å°æ—¶50åˆ†20ç§’", score: 280 },
            number: { duration: "2å°æ—¶55åˆ†12ç§’", score: 290 },
            hand: { duration: "2å°æ—¶50åˆ†10ç§’", score: 280 }
          },
          trainingLogs: [
            {
              date: "2025-07-26",
              game: "æ°´æœå¿è€…åº·å¤ç‰ˆ",
              score: 95,
              completion: "100%",
              duration: "30åˆ†é’Ÿ",
            },
            {
              date: "2025-07-25",
              game: "æ•°å­—è®¤çŸ¥è®­ç»ƒ",
              score: 88,
              completion: "98%",
              duration: "25åˆ†é’Ÿ",
            },
            {
              date: "2025-07-24",
              game: "æ‰‹éƒ¨ç²¾ç»†åŠ¨ä½œ",
              score: 92,
              completion: "95%",
              duration: "35åˆ†é’Ÿ",
            },
            {
              date: "2025-07-23",
              game: "å¹³è¡¡æ„Ÿè®­ç»ƒ",
              score: 87,
              completion: "100%",
              duration: "28åˆ†é’Ÿ",
            },
          ],
          riskAnalysis: [
            { action: "ä¸Šè‚¢å¤–å±•", error: "è§’åº¦ä¸è¶³", count: 15 },
            { action: "æ‰‹è…•æ—‹è½¬", error: "é€Ÿåº¦è¿‡å¿«", count: 8 },
            { action: "æ¡åŠ›è®­ç»ƒ", error: "æŒç»­æ—¶é—´ä¸å¤Ÿ", count: 5 },
          ],
          currentPlan:
            "æ¯æ—¥è¿›è¡Œä¸Šè‚¢åŠ›é‡è®­ç»ƒ30åˆ†é’Ÿï¼Œè®¤çŸ¥è®­ç»ƒ15åˆ†é’Ÿï¼Œé…åˆå¹³è¡¡æ„Ÿåè°ƒè®­ç»ƒã€‚",
        },
        102: {
          patientInfo: {
            id: 102,
            name: "æé˜¿å§¨",
            age: 68,
            stage: "æ¢å¤åˆæœŸ",
            diagnosis: "å³ä¾§è‚¢ä½“åŠŸèƒ½éšœç¢",
          },
          overview: {
            totalDuration: "3å°æ—¶18åˆ†25ç§’",
            avgAccuracy: "85%",
            thisWeekScore: 720,
            scoreTrend: [62, 65, 68, 72, 78, 82, 85],
          },
          gameDetails: {
            fruit: { duration: "1å°æ—¶8åˆ†15ç§’", score: 235 },
            number: { duration: "1å°æ—¶15åˆ†5ç§’", score: 245 },
            hand: { duration: "55åˆ†15ç§’", score: 240 }
          },
          trainingLogs: [
            {
              date: "2025-07-26",
              game: "åŸºç¡€æ‰‹éƒ¨è¿åŠ¨",
              score: 78,
              completion: "90%",
              duration: "25åˆ†é’Ÿ",
            },
            {
              date: "2025-07-25",
              game: "è®¤çŸ¥ååº”è®­ç»ƒ",
              score: 82,
              completion: "95%",
              duration: "20åˆ†é’Ÿ",
            },
            {
              date: "2025-07-24",
              game: "åè°ƒæ€§è®­ç»ƒ",
              score: 75,
              completion: "88%",
              duration: "30åˆ†é’Ÿ",
            },
          ],
          riskAnalysis: [
            { action: "æ‰‹æŒ‡æŠ“æ¡", error: "åŠ›åº¦ä¸å¤Ÿ", count: 12 },
            { action: "è‚©éƒ¨è¿åŠ¨", error: "å¹…åº¦è¿‡å°", count: 9 },
          ],
          currentPlan:
            "åŸºç¡€åº·å¤è®­ç»ƒä¸ºä¸»ï¼Œæ¯æ—¥æ‰‹éƒ¨ç²¾ç»†åŠ¨ä½œç»ƒä¹ 20åˆ†é’Ÿï¼Œè‚¢ä½“åè°ƒè®­ç»ƒ15åˆ†é’Ÿã€‚",
        },
        103: {
          patientInfo: {
            id: 103,
            name: "å¼ å…ˆç”Ÿ",
            age: 65,
            stage: "æ¢å¤åæœŸ",
            diagnosis: "è„‘æ¢—åé—ç—‡",
          },
          overview: {
            totalDuration: "12å°æ—¶52åˆ†17ç§’",
            avgAccuracy: "96%",
            thisWeekScore: 920,
            scoreTrend: [88, 90, 92, 94, 96, 96, 98],
          },
          gameDetails: {
            fruit: { duration: "4å°æ—¶17åˆ†25ç§’", score: 307 },
            number: { duration: "4å°æ—¶17åˆ†26ç§’", score: 306 },
            hand: { duration: "4å°æ—¶17åˆ†26ç§’", score: 307 }
          },
          trainingLogs: [
            {
              date: "2025-07-26",
              game: "é«˜çº§åè°ƒè®­ç»ƒ",
              score: 98,
              completion: "100%",
              duration: "40åˆ†é’Ÿ",
            },
            {
              date: "2025-07-25",
              game: "å¤æ‚è®¤çŸ¥ä»»åŠ¡",
              score: 96,
              completion: "100%",
              duration: "35åˆ†é’Ÿ",
            },
            {
              date: "2025-07-24",
              game: "ç²¾ç»†è¿åŠ¨æ§åˆ¶",
              score: 97,
              completion: "98%",
              duration: "45åˆ†é’Ÿ",
            },
          ],
          riskAnalysis: [
            { action: "å¤æ‚åŠ¨ä½œåºåˆ—", error: "å¶æœ‰åœé¡¿", count: 3 },
            { action: "åŒæ‰‹åè°ƒ", error: "è½»å¾®ä¸åŒæ­¥", count: 2 },
          ],
          currentPlan:
            "ç»´æŒæ€§è®­ç»ƒï¼Œæ¯æ—¥é«˜çº§åº·å¤è®­ç»ƒ40åˆ†é’Ÿï¼Œè®¤çŸ¥åŠŸèƒ½å¼ºåŒ–è®­ç»ƒ20åˆ†é’Ÿã€‚",
        },
        104: {
          patientInfo: {
            id: 104,
            name: "é™ˆå¥¶å¥¶",
            age: 74,
            stage: "æ¢å¤åˆæœŸ",
            diagnosis: "è®¤çŸ¥åŠŸèƒ½éšœç¢",
          },
          overview: {
            totalDuration: "2å°æ—¶25åˆ†30ç§’",
            avgAccuracy: "78%",
            thisWeekScore: 560,
            scoreTrend: [48, 52, 55, 58, 65, 68, 72],
          },
          gameDetails: {
            fruit: { duration: "48åˆ†10ç§’", score: 185 },
            number: { duration: "50åˆ†15ç§’", score: 188 },
            hand: { duration: "47åˆ†05ç§’", score: 187 }
          },
          trainingLogs: [
            {
              date: "2025-07-26",
              game: "åŸºç¡€è®¤çŸ¥è®­ç»ƒ",
              score: 72,
              completion: "85%",
              duration: "20åˆ†é’Ÿ",
            },
            {
              date: "2025-07-25",
              game: "æ‰‹éƒ¨åè°ƒè®­ç»ƒ",
              score: 68,
              completion: "80%",
              duration: "18åˆ†é’Ÿ",
            },
          ],
          riskAnalysis: [
            { action: "è®°å¿†è®­ç»ƒ", error: "ååº”æ—¶é—´è¿‡é•¿", count: 18 },
            { action: "æ³¨æ„åŠ›é›†ä¸­", error: "å®¹æ˜“åˆ†å¿ƒ", count: 15 },
          ],
          currentPlan:
            "è½»åº¦è®¤çŸ¥è®­ç»ƒä¸ºä¸»ï¼Œæ¯æ—¥è®°å¿†è®­ç»ƒ15åˆ†é’Ÿï¼Œæ³¨æ„åŠ›è®­ç»ƒ10åˆ†é’Ÿã€‚",
        },
        105: {
          patientInfo: {
            id: 105,
            name: "èµµå”å”",
            age: 69,
            stage: "æ¢å¤ä¸­æœŸ",
            diagnosis: "è¿åŠ¨åŠŸèƒ½éšœç¢",
          },
          overview: {
            totalDuration: "6å°æ—¶16åˆ†48ç§’",
            avgAccuracy: "89%",
            thisWeekScore: 780,
            scoreTrend: [68, 72, 75, 78, 82, 87, 89],
          },
          gameDetails: {
            fruit: { duration: "2å°æ—¶25åˆ†16ç§’", score: 260 },
            number: { duration: "2å°æ—¶25åˆ†18ç§’", score: 260 },
            hand: { duration: "2å°æ—¶25åˆ†14ç§’", score: 260 }
          },
          trainingLogs: [
            {
              date: "2025-07-26",
              game: "è¿åŠ¨åè°ƒè®­ç»ƒ",
              score: 89,
              completion: "95%",
              duration: "35åˆ†é’Ÿ",
            },
            {
              date: "2025-07-25",
              game: "å¹³è¡¡æ„Ÿè®­ç»ƒ",
              score: 85,
              completion: "92%",
              duration: "30åˆ†é’Ÿ",
            },
          ],
          riskAnalysis: [
            { action: "å¹³è¡¡æ§åˆ¶", error: "ç¨³å®šæ€§ä¸è¶³", count: 8 },
            { action: "æ­¥æ€è®­ç»ƒ", error: "æ­¥å¹…ä¸å‡", count: 6 },
          ],
          currentPlan:
            "è¿åŠ¨åŠŸèƒ½æ¢å¤è®­ç»ƒï¼Œæ¯æ—¥å¹³è¡¡è®­ç»ƒ25åˆ†é’Ÿï¼Œæ­¥æ€è®­ç»ƒ20åˆ†é’Ÿã€‚",
        },
      };

      // é¡µé¢åˆå§‹åŒ–
      // é¡µé¢åˆå§‹åŒ–ï¼ˆæ”¹è¿›ç‰ˆï¼‰
      document.addEventListener("DOMContentLoaded", function () {
        try {
          console.log('ğŸš€ é¡µé¢å¼€å§‹åˆå§‹åŒ–...');
          
          // å¼ºåˆ¶æ¸…é™¤å¯èƒ½çš„ç¼“å­˜é—®é¢˜
          if (window.performance && window.performance.navigation.type === 1) {
            console.log('ğŸ”„ æ£€æµ‹åˆ°é¡µé¢åˆ·æ–°ï¼Œæ¸…ç†ç¼“å­˜...');
            try {
              // æ¸…ç†å¯èƒ½çš„è¿æ¥æ®‹ç•™
              if (window.networkConfig && window.networkConfig.eventSource) {
                window.networkConfig.eventSource.close();
                window.networkConfig.eventSource = null;
              }
            } catch (e) {
              console.warn('æ¸…ç†è¿æ¥æ®‹ç•™æ—¶å‡ºç°é—®é¢˜:', e);
            }
          }
          
          loadPersistedPatientData(); // åŠ è½½æŒä¹…åŒ–çš„æ‚£è€…æ•°æ®
          loadPatientList();
          initWebSocket();
          initGameDataReceiver();
          loadGameDataFromStorage();
          initResizableSidebars(); // åˆå§‹åŒ–å¯è°ƒæ•´å¤§å°çš„ä¾§è¾¹æ 
          
          // ç¡®ä¿äº‹ä»¶ç›‘å¬å™¨æ­£ç¡®ç»‘å®š
          bindEventListeners();
          
          // å»¶è¿Ÿåˆå§‹åŒ–ç½‘ç»œè¿æ¥ï¼Œç¡®ä¿DOMå®Œå…¨åŠ è½½
          setTimeout(() => {
            try {
              initNetworkConnection(); // åˆå§‹åŒ–ç½‘ç»œè¿æ¥ï¼ŒåŒ…å«è‡ªåŠ¨æ£€æµ‹
            } catch (error) {
              console.error('ç½‘ç»œè¿æ¥åˆå§‹åŒ–å¤±è´¥:', error);
            }
          }, 500);
          
          console.log('âœ… é¡µé¢åˆå§‹åŒ–å®Œæˆ');
        } catch (error) {
          console.error('âŒ é¡µé¢åˆå§‹åŒ–è¿‡ç¨‹å‡ºé”™:', error);
          alert('é¡µé¢åˆå§‹åŒ–å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•');
        }
      });
      
      // ç»‘å®šäº‹ä»¶ç›‘å¬å™¨
      function bindEventListeners() {
        try {
          console.log('ğŸ”— ç»‘å®šäº‹ä»¶ç›‘å¬å™¨...');
          
          // ç¡®ä¿è¿æ¥æŒ‰é’®äº‹ä»¶ç»‘å®š
          const connectBtn = document.querySelector('button[onclick="connectToNetwork()"]');
          if (connectBtn) {
            // ç§»é™¤å¯èƒ½çš„æ—§äº‹ä»¶ç›‘å¬å™¨
            connectBtn.onclick = null;
            // é‡æ–°ç»‘å®š
            connectBtn.onclick = function(e) {
              e.preventDefault();
              e.stopPropagation();
              console.log('ğŸ”— è¿æ¥æŒ‰é’®è¢«ç‚¹å‡»');
              connectToNetwork();
            };
          }
          
          // ç¡®ä¿é‡æ–°æ£€æµ‹æŒ‰é’®äº‹ä»¶ç»‘å®š
          const reDetectBtn = document.querySelector('button[onclick="reDetectServer()"]');
          if (reDetectBtn) {
            // ç§»é™¤å¯èƒ½çš„æ—§äº‹ä»¶ç›‘å¬å™¨
            reDetectBtn.onclick = null;
            // é‡æ–°ç»‘å®š
            reDetectBtn.onclick = function(e) {
              e.preventDefault();
              e.stopPropagation();
              console.log('ğŸ”„ é‡æ–°æ£€æµ‹æŒ‰é’®è¢«ç‚¹å‡»');
              reDetectServer();
            };
          }
          
          // é¡µé¢å¸è½½æ—¶æ¸…ç†è¿æ¥
          window.addEventListener('beforeunload', function() {
            console.log('ğŸ§¹ é¡µé¢å¸è½½ï¼Œæ¸…ç†è¿æ¥...');
            cleanupConnection();
          });
          
          // é¡µé¢å¯è§æ€§å˜åŒ–æ—¶çš„å¤„ç†
          document.addEventListener('visibilitychange', function() {
            if (document.hidden) {
              console.log('ğŸ“± é¡µé¢éšè—');
            } else {
              console.log('ğŸ“± é¡µé¢æ˜¾ç¤º');
              // é¡µé¢é‡æ–°æ˜¾ç¤ºæ—¶æ£€æŸ¥è¿æ¥çŠ¶æ€
              if (networkConfig.serverUrl && !networkConfig.connected) {
                console.log('ğŸ”„ é¡µé¢é‡æ–°æ˜¾ç¤ºï¼Œæ£€æŸ¥è¿æ¥çŠ¶æ€...');
                setTimeout(() => {
                  if (!networkConfig.connected) {
                    console.log('ğŸ”— è‡ªåŠ¨é‡æ–°è¿æ¥...');
                    connectToNetwork();
                  }
                }, 1000);
              }
            }
          });
          
          console.log('âœ… äº‹ä»¶ç›‘å¬å™¨ç»‘å®šå®Œæˆ');
        } catch (error) {
          console.error('âŒ ç»‘å®šäº‹ä»¶ç›‘å¬å™¨å¤±è´¥:', error);
        }
      }

      // åŠ è½½æŒä¹…åŒ–çš„æ‚£è€…æ•°æ®
      function loadPersistedPatientData() {
        try {
          // å…ˆæ¸…é™¤æ—§çš„localStorageæ•°æ®ï¼Œä½¿ç”¨æ–°çš„æ¨¡æ‹Ÿæ•°æ®
          localStorage.removeItem("yihu_patient_data");
          console.log("å·²æ¸…é™¤æ—§çš„æ‚£è€…æ•°æ®ï¼Œä½¿ç”¨æ–°çš„æ¨¡æ‹Ÿæ•°æ®");
          
          // ä¸å†ä»localStorageåŠ è½½æ•°æ®ï¼Œç›´æ¥ä½¿ç”¨æ›´æ–°åçš„æ¨¡æ‹Ÿæ•°æ®
          // const persistedData = localStorage.getItem("yihu_patient_data");
          // if (persistedData) {
          //   // æ³¨é‡Šæ‰æ—§çš„æ•°æ®åŠ è½½é€»è¾‘
          // }
        } catch (error) {
          console.error("å¤„ç†æŒä¹…åŒ–æ•°æ®å¤±è´¥:", error);
        }
      }

      // ä¿å­˜æ‚£è€…æ•°æ®åˆ°æŒä¹…åŒ–å­˜å‚¨
      function savePatientDataToPersistence() {
        try {
          const dataToSave = {};
          Object.keys(mockPatientReports).forEach((patientId) => {
            dataToSave[patientId] = {
              thisWeekScore:
                mockPatientReports[patientId].overview.thisWeekScore,
              totalDuration:
                mockPatientReports[patientId].overview.totalDuration,
              gameDetails: mockPatientReports[patientId].gameDetails,
            };
          });
          localStorage.setItem("yihu_patient_data", JSON.stringify(dataToSave));
          console.log("æ‚£è€…æ•°æ®å·²ä¿å­˜åˆ°æŒä¹…åŒ–å­˜å‚¨");
        } catch (error) {
          console.error("ä¿å­˜æŒä¹…åŒ–æ•°æ®å¤±è´¥:", error);
        }
      }

      // æœ¬åœ°æ•°æ®ç›‘å¬å™¨å¼•ç”¨
      let localDataCheckInterval = null;
      let storageEventListener = null;
      let postMessageListener = null;
      
      // åˆå§‹åŒ–æ¸¸æˆæ•°æ®æ¥æ”¶å™¨
      function initGameDataReceiver() {
        // æ¸…ç†å·²æœ‰çš„ç›‘å¬å™¨
        if (localDataCheckInterval) {
          clearInterval(localDataCheckInterval);
          localDataCheckInterval = null;
        }
        
        // postMessageç›‘å¬å™¨
        postMessageListener = function (event) {
          if (event.data && event.data.type === "GAME_DATA_UPLOAD") {
            // ä»…åœ¨æœªè¿æ¥ç½‘ç»œæ—¶å¤„ç†æœ¬åœ°æ•°æ®
            if (!networkConfig.connected) {
              console.log("æ¥æ”¶åˆ°æœ¬åœ°æ¸¸æˆæ•°æ®:", event.data.data);
              handleGameDataUpdate(event.data.data);
            }
          }
        };
        
        // storageäº‹ä»¶ç›‘å¬å™¨
        storageEventListener = function(event) {
          if (event.key === 'gameUploadData' || event.key === null) {
            // ä»…åœ¨æœªè¿æ¥ç½‘ç»œæ—¶å¤„ç†æœ¬åœ°æ•°æ®
            if (!networkConfig.connected) {
              console.log('æ£€æµ‹åˆ°localStorageå˜åŒ–ï¼Œç«‹å³æ£€æŸ¥æ–°æ•°æ®');
              loadGameDataFromStorage();
            }
          }
        };
        
        // æ·»åŠ ç›‘å¬å™¨
        window.addEventListener("message", postMessageListener);
        window.addEventListener('storage', storageEventListener);

        // ä»…åœ¨æœªè¿æ¥ç½‘ç»œæ—¶å¯ç”¨å®šæœŸæ£€æŸ¥
        if (!networkConfig.connected) {
          localDataCheckInterval = setInterval(function () {
            if (!networkConfig.connected) {
              loadGameDataFromStorage();
            }
          }, 2000);
        }

        console.log('æ¸¸æˆæ•°æ®æ¥æ”¶å™¨å·²åˆå§‹åŒ– - ç½‘ç»œçŠ¶æ€:', networkConfig.connected ? 'å·²è¿æ¥' : 'æœ¬åœ°æ¨¡å¼');
      }

      // ä»localStorageåŠ è½½æ¸¸æˆæ•°æ®
      function loadGameDataFromStorage() {
        try {
          const gameData = JSON.parse(
            localStorage.getItem("gameUploadData") || "[]"
          );
          if (gameData.length > 0) {
            gameData.forEach((data) => {
              if (data.patientId === 102) {
                // æé˜¿å§¨
                handleGameDataUpdate(data);
              }
            });
            // æ¸…ç©ºå·²å¤„ç†çš„æ•°æ®
            localStorage.removeItem("gameUploadData");
            console.log("å·²å¤„ç†æ¸¸æˆæ•°æ®:", gameData.length, "æ¡");
          }
        } catch (error) {
          console.error("è¯»å–æ¸¸æˆæ•°æ®å¤±è´¥:", error);
        }
      }

      // æ•°æ®å»é‡ç¼“å­˜ - åŠ å¼ºç‰ˆæœ¬
      const processedDataIds = new Set();
      let lastProcessedTime = 0;
      
      // å¤„ç†æ¸¸æˆæ•°æ®æ›´æ–°
      function handleGameDataUpdate(data, skipNotification = false) {
        if (data.patientId === 102) {
          // æé˜¿å§¨
          updatePatientGameData(data, skipNotification);
        }
      }

      // æ›´æ–°æé˜¿å§¨çš„æ¸¸æˆæ•°æ®
      function updatePatientGameData(data, skipNotification = false) {
        const report = mockPatientReports[102];
        if (!report) return;

        // åŠ å¼ºçš„æ•°æ®å»é‡é€»è¾‘
        const currentTime = Date.now();
        
        // ç”Ÿæˆæ›´åŠ å”¯ä¸€çš„æ•°æ®ID
        const dataId = `${data.patientId}-${data.gameType}-${data.scoreIncrease || 0}-${data.timeIncrease || 0}-${data.source || 'unknown'}-${Math.floor(currentTime / 1000)}`;
        
        // é˜²æ­¢è¿‡äºé¢‘ç¹çš„æ•°æ®å¤„ç†ï¼ˆåŒä¸€ç§’å†…æœ€å¤šå¤„ç†ä¸€æ¬¡ï¼‰
        if (currentTime - lastProcessedTime < 500) {
          console.log('æ•°æ®å¤„ç†è¿‡äºé¢‘ç¹ï¼Œè·³è¿‡:', dataId);
          return;
        }
        
        // æ£€æŸ¥æ˜¯å¦å·²å¤„ç†è¿‡è¿™ä¸ªæ•°æ®
        if (processedDataIds.has(dataId)) {
          console.log('æ•°æ®å·²å¤„ç†è¿‡ï¼Œè·³è¿‡é‡å¤å¤„ç†:', dataId);
          return;
        }
        
        // å¦‚æœå¾—åˆ†å’Œæ—¶é•¿å¢åŠ éƒ½ä¸º0æˆ–undefinedï¼Œè·³è¿‡å¤„ç†
        if ((!data.scoreIncrease || data.scoreIncrease <= 0) && (!data.timeIncrease || data.timeIncrease <= 0)) {
          console.log('æ— æœ‰æ•ˆæ•°æ®å¢é‡ï¼Œè·³è¿‡å¤„ç†:', dataId);
          return;
        }
        
        // æ ‡è®°æ•°æ®å·²å¤„ç†
        processedDataIds.add(dataId);
        lastProcessedTime = currentTime;
        
        console.log('âœ… å¤„ç†æ–°æ•°æ®:', dataId, 'å¾—åˆ†+' + (data.scoreIncrease || 0), 'æ—¶é•¿+' + (data.timeIncrease || 0) + 'ç§’');
        
        // ç¡®å®šæ˜¯å¦æ˜¾ç¤ºé€šçŸ¥ - å¯¹äºæœ‰æ•ˆçš„æ–°æ•°æ®ï¼Œæ€»æ˜¯æ˜¾ç¤ºé€šçŸ¥
        const shouldShowNotification = !skipNotification || (data.scoreIncrease && data.scoreIncrease > 0);
        
        // æ¸…ç†è¿‡æœŸçš„æ•°æ®IDï¼ˆä¿ç•™æœ€è¿‘50ä¸ªï¼Œå‡å°‘å†…å­˜å ç”¨ï¼‰
        if (processedDataIds.size > 50) {
          const idsArray = Array.from(processedDataIds);
          const keepIds = idsArray.slice(-50);
          processedDataIds.clear();
          keepIds.forEach(id => processedDataIds.add(id));
        }

        // ç¡®å®šæ¸¸æˆç±»å‹ - ä½¿ç”¨æ–°çš„æ¸¸æˆç±»å‹æ˜ å°„
        const gameType = data.gameType || 'coordination'; // é»˜è®¤ä¸ºæ‰‹çœ¼åè°ƒè®­ç»ƒ

        // ç´¯åŠ æœ¬å‘¨å¾—åˆ† - åªæœ‰å½“å¾—åˆ†å¢åŠ å¤§äº0æ—¶æ‰åŠ åˆ†
        if (data.scoreIncrease && data.scoreIncrease > 0) {
          report.overview.thisWeekScore += data.scoreIncrease;
          
          // å°†å¾—åˆ†åŠ åˆ°å¯¹åº”çš„æ¸¸æˆä¸­
          if (gameType === 'reaction') {
            report.gameDetails.fruit.score += data.scoreIncrease;
          } else if (gameType === 'cognitive') {
            report.gameDetails.number.score += data.scoreIncrease;
          } else if (gameType === 'coordination') {
            report.gameDetails.hand.score += data.scoreIncrease;
          }
        }

        // ç´¯åŠ æ€»è®­ç»ƒæ—¶é•¿ï¼ˆè½¬æ¢ä¸ºå°æ—¶åˆ†é’Ÿç§’æ ¼å¼ï¼‰ - åªè¦æœ‰æ—¶é•¿å¢åŠ å°±æ›´æ–°
        if (data.timeIncrease && data.timeIncrease > 0) {
          const currentDuration = parseTimeString(report.overview.totalDuration);
          const newTotalSeconds = currentDuration.totalSeconds + data.timeIncrease;
          report.overview.totalDuration = formatTimeFromSeconds(newTotalSeconds);
          
          // å°†æ—¶é•¿åŠ åˆ°å¯¹åº”çš„æ¸¸æˆä¸­
          if (gameType === 'reaction') {
            const fruitDuration = parseTimeString(report.gameDetails.fruit.duration);
            report.gameDetails.fruit.duration = formatTimeFromSeconds(
              fruitDuration.totalSeconds + data.timeIncrease
            );
          } else if (gameType === 'cognitive') {
            const numberDuration = parseTimeString(report.gameDetails.number.duration);
            report.gameDetails.number.duration = formatTimeFromSeconds(
              numberDuration.totalSeconds + data.timeIncrease
            );
          } else if (gameType === 'coordination') {
            const handDuration = parseTimeString(report.gameDetails.hand.duration);
            report.gameDetails.hand.duration = formatTimeFromSeconds(
              handDuration.totalSeconds + data.timeIncrease
            );
          }
        }

        // å¦‚æœå½“å‰æ˜¾ç¤ºçš„æ˜¯æé˜¿å§¨çš„ä¿¡æ¯ï¼Œç«‹å³æ›´æ–°æ˜¾ç¤º
        if (currentPatientId === 102) {
          document.getElementById("week-score").textContent =
            report.overview.thisWeekScore;
          document.getElementById("total-duration").textContent =
            report.overview.totalDuration;
          
          // æ›´æ–°æ¸¸æˆè¯¦ç»†æ•°æ®æ˜¾ç¤º
          updateGameDetails(report.gameDetails);
          
          // åˆ·æ–°è¿›åº¦å›¾è¡¨ï¼ˆåŒ…å«èƒ½åŠ›é˜¶æ®µï¼‰
          updateProgressChart(report.overview.scoreTrend);
        }

        // æ˜¾ç¤ºæ›´æ–°é€šçŸ¥ï¼ˆå¯¹äºæ–°çš„æœ‰æ•ˆæ•°æ®ï¼Œæ€»æ˜¯æ˜¾ç¤ºé€šçŸ¥ï¼‰
        if (shouldShowNotification) {
          const gameTypeName = getGameTypeName(data.gameType);
          const scoreText = `å¾—åˆ†+${data.scoreIncrease}åˆ†`;
          const timeText = `è®­ç»ƒæ—¶é•¿+${data.timeIncrease || 0}ç§’`;
          const sourceText = data.source ? ` (${data.source === 'network_sse' ? 'ç½‘ç»œ' : data.source === 'local' ? 'æœ¬åœ°' : data.source})` : '';
          
          const notification = {
            type: "info",
            patientId: 102,
            patientName: "æé˜¿å§¨",
            message: `æé˜¿å§¨æ­£åœ¨è¿›è¡Œ${gameTypeName}${scoreText}, ${timeText}${sourceText}`,
            timestamp: new Date().toLocaleTimeString(),
          };
          addNotification(notification);
          console.log('ğŸ“¢ æ˜¾ç¤ºé€šçŸ¥:', notification.message);
        }

        // ä¿å­˜æ•°æ®åˆ°æŒä¹…åŒ–å­˜å‚¨
        savePatientDataToPersistence();

        console.log("æé˜¿å§¨æ•°æ®å·²æ›´æ–°:", report.overview);
      }
      
      // è·å–æ¸¸æˆç±»å‹çš„ä¸­æ–‡åç§°
      function getGameTypeName(gameType) {
        const gameNames = {
          'coordination': 'æ‰‹çœ¼åè°ƒè®­ç»ƒ', // æ‰“ç –å—æ¸¸æˆ
          'reaction': 'ååº”é€Ÿåº¦è®­ç»ƒ',     // æ°´æœå¿è€…æ¸¸æˆ
          'cognitive': 'è®¤çŸ¥èƒ½åŠ›è®­ç»ƒ'     // æ•°å­—è®¤çŸ¥æ¸¸æˆ
        };
        return gameNames[gameType] ? gameNames[gameType] + ' ' : '';
      }



      // è§£ææ—¶é—´å­—ç¬¦ä¸²ï¼ˆå¦‚"96å°æ—¶18åˆ†25ç§’"ï¼‰
      function parseTimeString(timeStr) {
        const hourMatch = timeStr.match(/(\d+)å°æ—¶/);
        const minMatch = timeStr.match(/(\d+)åˆ†/);
        const secMatch = timeStr.match(/(\d+)ç§’/);

        const hours = hourMatch ? parseInt(hourMatch[1]) : 0;
        const minutes = minMatch ? parseInt(minMatch[1]) : 0;
        const seconds = secMatch ? parseInt(secMatch[1]) : 0;

        return {
          hours: hours,
          minutes: minutes,
          seconds: seconds,
          totalSeconds: hours * 3600 + minutes * 60 + seconds,
        };
      }

      // å°†ç§’æ•°æ ¼å¼åŒ–ä¸º"å°æ—¶åˆ†é’Ÿç§’"æ ¼å¼
      function formatTimeFromSeconds(totalSeconds) {
        const hours = Math.floor(totalSeconds / 3600);
        const minutes = Math.floor((totalSeconds % 3600) / 60);
        const seconds = totalSeconds % 60;

        return `${hours}å°æ—¶${minutes}åˆ†${seconds}ç§’`;
      }

      // åŠ è½½æ‚£è€…åˆ—è¡¨
      function loadPatientList() {
        const patientListElement = document.getElementById("patient-list");
        const countElement = document.getElementById("patient-count");

        setTimeout(() => {
          patientListElement.innerHTML = "";

          mockPatients.forEach((patient) => {
            const patientItem = createPatientListItem(patient);
            patientListElement.appendChild(patientItem);
          });

          countElement.textContent = `${mockPatients.length} ä½æ‚£è€…`;
        }, 300);
      }

      // åˆ›å»ºæ‚£è€…åˆ—è¡¨é¡¹
      function createPatientListItem(patient) {
        const div = document.createElement("div");
        div.className =
          "patient-item p-4 rounded-xl cursor-pointer transition-all duration-300";
        div.onclick = () => selectPatient(patient.id);

        div.innerHTML = `
                <div class="flex items-center space-x-4">
                    <div class="status-indicator status-${
                      patient.status
                    }"></div>
                    <div class="w-12 h-12 bg-gradient-to-br from-apple-gray-3 to-apple-gray-4 rounded-xl flex items-center justify-center">
                        <i data-lucide="user" class="text-white w-5 h-5"></i>
                    </div>
                    <div class="flex-1">
                        <h3 class="font-semibold text-gray-900 tracking-tight">${
                          patient.name
                        }</h3>
                        <p class="text-sm text-apple-gray-6">${
                          patient.age
                        }å²</p>
                    </div>
                    <div class="text-right">
                        <span class="text-xs px-2 py-1 rounded-lg font-medium ${
                          patient.status === "training"
                            ? "bg-apple-green/10 text-apple-green"
                            : "bg-apple-gray-2 text-apple-gray-6"
                        }">
                            ${patient.status === "training" ? "è®­ç»ƒä¸­" : "ç©ºé—²"}
                        </span>
                    </div>
                </div>
            `;

        return div;
      }

      // é€‰æ‹©æ‚£è€…
      function selectPatient(patientId) {
        document.querySelectorAll(".patient-item").forEach((item) => {
          item.classList.remove("active");
        });
        event.currentTarget.classList.add("active");

        currentPatientId = patientId;
        loadPatientDetail(patientId);
      }

      // åŠ è½½æ‚£è€…è¯¦æƒ…
      function loadPatientDetail(patientId) {
        const report = mockPatientReports[patientId];
        if (!report) return;

        document.getElementById("default-view").classList.add("hidden");
        const detailElement = document.getElementById("patient-detail");
        detailElement.classList.remove("hidden");

        // æ›´æ–°æ‚£è€…åŸºæœ¬ä¿¡æ¯
        document.getElementById("patient-name").textContent =
          report.patientInfo.name;
        document.getElementById(
          "patient-age"
        ).textContent = `${report.patientInfo.age}å²`;
        document.getElementById("patient-stage").textContent =
          report.patientInfo.stage;
        document.getElementById("patient-diagnosis").textContent =
          report.patientInfo.diagnosis;

        // æ›´æ–°KPIå¡ç‰‡
        document.getElementById("total-duration").textContent =
          report.overview.totalDuration;
        document.getElementById("avg-accuracy").textContent =
          report.overview.avgAccuracy;
        document.getElementById("week-score").textContent =
          report.overview.thisWeekScore;
        document.getElementById("progress-rate").textContent = `${Math.round(
          (report.overview.scoreTrend[report.overview.scoreTrend.length - 1] /
            100) *
            100
        )}%`;

        // æ›´æ–°æ¸¸æˆè¯¦ç»†æ•°æ®
        updateGameDetails(report.gameDetails);

        // æ›´æ–°åº·å¤è®¡åˆ’
        document.getElementById("current-plan").textContent =
          report.currentPlan;

        // æ›´æ–°å›¾è¡¨
        updateProgressChart(report.overview.scoreTrend);

        // æ›´æ–°è®­ç»ƒæ—¥å¿—
        updateTrainingLogs(report.trainingLogs);

        // æ›´æ–°é£é™©åˆ†æ
        updateRiskAnalysis(report.riskAnalysis);

        // é‡æ–°åˆå§‹åŒ–å›¾æ ‡
        lucide.createIcons();
      }

      // æ›´æ–°è¿›åº¦å›¾è¡¨ï¼ˆåŒ…å«èƒ½åŠ›é˜¶æ®µæŸ±çŠ¶å›¾ï¼‰
      function updateProgressChart(data) {
        const ctx = document.getElementById("progress-chart").getContext("2d");

        if (progressChart) {
          progressChart.destroy();
        }

        const labels = data.map((_, index) => `ç¬¬${index + 1}å¤©`);
        
        // è·å–å½“å‰æ‚£è€…çš„æœ€æ–°å¾—åˆ†
        const currentScore = data[data.length - 1];
        
        // å‡†å¤‡èƒ½åŠ›é˜¶æ®µæ•°æ®
        const capabilityLabels = capabilityThresholds.map(t => t.capability);
        const capabilityData = capabilityThresholds.map(t => {
          // å¦‚æœæ‚£è€…å¾—åˆ†è¾¾åˆ°è¯¥é˜ˆå€¼ï¼Œåˆ™æ˜¾ç¤ºè¯¥èƒ½åŠ›çš„å®Œæ•´é«˜åº¦ï¼Œå¦åˆ™æ˜¾ç¤ºè¾ƒä½çš„é«˜åº¦
          return currentScore >= t.threshold ? t.threshold : t.threshold * 0.3;
        });
        const capabilityColors = capabilityThresholds.map(t => 
          currentScore >= t.threshold ? t.color : t.color.replace('0.8', '0.3')
        );

        progressChart = new Chart(ctx, {
          type: "line",
          data: {
            labels: labels,
            datasets: [
              {
                label: "åº·å¤å¾—åˆ†",
                data: data,
                borderColor: "#007AFF",
                backgroundColor: "rgba(0, 122, 255, 0.1)",
                borderWidth: 3,
                fill: true,
                tension: 0.4,
                pointBackgroundColor: "#007AFF",
                pointBorderColor: "#ffffff",
                pointBorderWidth: 3,
                pointRadius: 6,
                pointHoverRadius: 8,
                yAxisID: 'y',
              },
              {
                type: 'bar',
                label: "åŠŸèƒ½èƒ½åŠ›é˜¶æ®µ",
                data: capabilityData,
                backgroundColor: capabilityColors,
                borderColor: capabilityColors.map(color => color.replace('0.8', '1')),
                borderWidth: 1,
                barThickness: 15,
                categoryPercentage: 0.5,
                yAxisID: 'y1',
              }
            ],
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            interaction: {
              mode: 'index',
              intersect: false,
            },
            plugins: {
              legend: {
                display: true,
                position: 'top',
                labels: {
                  color: "#8E8E93",
                  font: {
                    family: "Inter",
                    size: 12,
                  },
                  usePointStyle: true,
                  filter: function(item, chart) {
                    return item.datasetIndex === 0; // åªæ˜¾ç¤ºæŠ˜çº¿å›¾çš„å›¾ä¾‹
                  }
                }
              },
              tooltip: {
                callbacks: {
                  title: function(context) {
                    if (context[0].datasetIndex === 0) {
                      return context[0].label;
                    } else {
                      return 'åŠŸèƒ½èƒ½åŠ›é˜¶æ®µ';
                    }
                  },
                  label: function(context) {
                    if (context.datasetIndex === 0) {
                      return `åº·å¤å¾—åˆ†: ${context.parsed.y}åˆ†`;
                    } else {
                      const capability = capabilityThresholds[context.dataIndex];
                      const achieved = currentScore >= capability.threshold;
                      return `${capability.capability}: ${achieved ? 'å·²è¾¾æˆ' : 'æœªè¾¾æˆ'} (éœ€è¦${capability.threshold}åˆ†)`;
                    }
                  }
                }
              }
            },
            scales: {
              y: {
                type: 'linear',
                display: true,
                position: 'left',
                beginAtZero: true,
                max: 100,
                grid: {
                  color: "rgba(0, 0, 0, 0.05)",
                  borderDash: [5, 5],
                },
                ticks: {
                  color: "#8E8E93",
                  font: {
                    family: "Inter",
                    size: 12,
                  },
                },
                title: {
                  display: true,
                  text: 'åº·å¤å¾—åˆ†',
                  color: "#007AFF",
                  font: {
                    family: "Inter",
                    size: 13,
                    weight: 'bold'
                  }
                }
              },
              y1: {
                type: 'linear',
                display: true,
                position: 'right',
                beginAtZero: true,
                max: 100,
                grid: {
                  drawOnChartArea: false,
                },
                ticks: {
                  color: "#8E8E93",
                  font: {
                    family: "Inter",
                    size: 12,
                  },
                  callback: function(value) {
                    const threshold = capabilityThresholds.find(t => t.threshold === value);
                    return threshold ? threshold.capability : '';
                  }
                },
                title: {
                  display: true,
                  text: 'åŠŸèƒ½èƒ½åŠ›',
                  color: "#34C759",
                  font: {
                    family: "Inter",
                    size: 13,
                    weight: 'bold'
                  }
                }
              },
              x: {
                grid: {
                  color: "rgba(0, 0, 0, 0.05)",
                  borderDash: [5, 5],
                },
                ticks: {
                  color: "#8E8E93",
                  font: {
                    family: "Inter",
                    size: 12,
                  },
                },
              },
            },
          },
        });
      }



      // æ›´æ–°è®­ç»ƒæ—¥å¿—
      function updateTrainingLogs(logs) {
        const container = document.getElementById("training-logs");
        container.innerHTML = "";

        logs.forEach((log) => {
          const logItem = document.createElement("div");
          logItem.className =
            "bg-apple-gray-1/50 rounded-xl p-4 hover:bg-apple-gray-1 transition-colors duration-200";
          logItem.innerHTML = `
                    <div class="flex items-center justify-between mb-2">
                        <h4 class="font-semibold text-gray-900">${log.game}</h4>
                        <span class="text-xs px-2 py-1 rounded-lg font-medium ${getScoreBadgeClass(
                          log.score
                        )}">
                            ${log.score}åˆ†
                        </span>
                    </div>
                    <div class="flex justify-between text-sm text-apple-gray-6">
                        <span>${log.date}</span>
                        <span>å®Œæˆç‡: ${log.completion}</span>
                        <span>æ—¶é•¿: ${log.duration}</span>
                    </div>
                `;
          container.appendChild(logItem);
        });
      }

      // è·å–å¾—åˆ†å¾½ç« æ ·å¼
      function getScoreBadgeClass(score) {
        if (score >= 90) return "bg-apple-green/10 text-apple-green";
        if (score >= 70) return "bg-apple-orange/10 text-apple-orange";
        return "bg-apple-red/10 text-apple-red";
      }

      // æ›´æ–°é£é™©åˆ†æ
      function updateRiskAnalysis(risks) {
        const container = document.getElementById("risk-analysis");
        container.innerHTML = "";

        if (risks.length === 0) {
          container.innerHTML =
            '<p class="text-apple-gray-6 text-center py-8">æš‚æ— é£é™©æç¤º</p>';
          return;
        }

        risks.forEach((risk) => {
          const riskItem = document.createElement("div");
          riskItem.className = `p-4 rounded-xl border-l-4 ${getRiskBorderClass(
            risk.count
          )} transition-all duration-200 hover:shadow-sm`;
          riskItem.innerHTML = `
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="font-semibold text-gray-900">${risk.action}</p>
                            <p class="text-sm text-apple-gray-6 mt-1">${risk.error}</p>
                        </div>
                        <span class="bg-apple-gray-2 text-apple-gray-6 text-xs font-medium px-3 py-1 rounded-full">
                            ${risk.count}æ¬¡
                        </span>
                    </div>
                `;
          container.appendChild(riskItem);
        });
      }

      // è·å–é£é™©è¾¹æ¡†æ ·å¼
      function getRiskBorderClass(count) {
        if (count >= 10) return "border-apple-red bg-apple-red/5";
        if (count >= 5) return "border-apple-orange bg-apple-orange/5";
        return "border-apple-blue bg-apple-blue/5";
      }

      // åˆå§‹åŒ–WebSocketè¿æ¥
      function initWebSocket() {
        const wsStatus = document.getElementById("ws-status");

        setTimeout(() => {
          wsStatus.className = "status-indicator status-training";
          simulateRealtimeMessages();
        }, 1000);
      }

      // æ¨¡æ‹Ÿå®æ—¶æ¶ˆæ¯
      function simulateRealtimeMessages() {
        const messages = [
          {
            type: "alert",
            patientId: 102,
            patientName: "æé˜¿å§¨",
            message: "è¿ç»­3æ¬¡'æ‰‹è…•æ—‹è½¬'åŠ¨ä½œé”™è¯¯",
            timestamp: new Date().toLocaleTimeString(),
          },
        ];

        let messageIndex = 0;
        setInterval(() => {
          if (messageIndex < messages.length) {
            handleWebSocketMessage(messages[messageIndex]);
            messageIndex++;
          } else {
            if (Math.random() < 0.2) {
              const randomPatient =
                mockPatients[Math.floor(Math.random() * mockPatients.length)];
              const alertMessage = {
                type: "alert",
                patientId: randomPatient.id,
                patientName: randomPatient.name,
                message: "è®­ç»ƒä¸­æ£€æµ‹åˆ°å¼‚å¸¸åŠ¨ä½œ",
                timestamp: new Date().toLocaleTimeString(),
              };
              handleWebSocketMessage(alertMessage);
            }
          }
        }, 15000);
      }

      // å¤„ç†WebSocketæ¶ˆæ¯
      function handleWebSocketMessage(data) {
        if (data.type === "alert") {
          addNotification(data);
        } else if (data.type === "status_update") {
          updatePatientStatus(data.patientId, data.newStatus);
        }
      }

      // æ·»åŠ é€šçŸ¥
      function addNotification(alert) {
        const notificationsContainer = document.getElementById("notifications");

        if (notificationsContainer.querySelector(".text-center")) {
          notificationsContainer.innerHTML = "";
        }

        // æ ¹æ®é€šçŸ¥ç±»å‹é€‰æ‹©å›¾æ ‡å’Œé¢œè‰²
        let iconClass, colorClass, iconName;
        if (alert.type === "info") {
          iconClass = "bg-apple-blue/10";
          colorClass = "text-apple-blue";
          iconName = "info";
        } else {
          iconClass = "bg-apple-orange/10";
          colorClass = "text-apple-orange";
          iconName = "alert-triangle";
        }

        const notification = document.createElement("div");
        notification.className = "notification-card rounded-xl p-4 shadow-sm";
        notification.innerHTML = `
                <div class="flex items-start space-x-3">
                    <div class="w-8 h-8 ${iconClass} rounded-lg flex items-center justify-center flex-shrink-0">
                        <i data-lucide="${iconName}" class="${colorClass} w-4 h-4"></i>
                    </div>
                    <div class="flex-1">
                        <p class="font-semibold text-gray-900 text-sm">${alert.patientName}</p>
                        <p class="text-sm text-gray-600 mt-1 leading-relaxed">${alert.message}</p>
                        <p class="text-xs text-apple-gray-6 mt-2">${alert.timestamp}</p>
                    </div>
                </div>
            `;

        notificationsContainer.insertBefore(
          notification,
          notificationsContainer.firstChild
        );

        // é‡æ–°åˆå§‹åŒ–å›¾æ ‡
        lucide.createIcons();

        const notifications =
          notificationsContainer.querySelectorAll(".notification-card");
        if (notifications.length > 8) {
          notificationsContainer.removeChild(
            notifications[notifications.length - 1]
          );
        }
      }

      // æ›´æ–°æ‚£è€…çŠ¶æ€
      function updatePatientStatus(patientId, newStatus) {
        const patientItems = document.querySelectorAll(".patient-item");
        patientItems.forEach((item) => {
          const indicator = item.querySelector(".status-indicator");
          if (indicator) {
            indicator.className = `status-indicator status-${newStatus}`;
          }
        });
      }

      // æ›´æ–°æ¸¸æˆè¯¦ç»†æ•°æ®
      function updateGameDetails(gameDetails) {
        document.getElementById("fruit-duration").textContent =
          gameDetails.fruit.duration;
        document.getElementById("number-duration").textContent =
          gameDetails.number.duration;
        document.getElementById("hand-duration").textContent =
          gameDetails.hand.duration;
        document.getElementById("fruit-score").textContent =
          gameDetails.fruit.score;
        document.getElementById("number-score").textContent =
          gameDetails.number.score;
        document.getElementById("hand-score").textContent =
          gameDetails.hand.score;
      }

      // åˆå§‹åŒ–å¯è°ƒæ•´å¤§å°çš„ä¾§è¾¹æ åŠŸèƒ½
      function initResizableSidebars() {
        // ä»localStorageåŠ è½½ä¿å­˜çš„è®¾ç½®
        loadSidebarSettings();

        // åˆå§‹åŒ–æ‚£è€…ä¾§è¾¹æ 
        initSidebarResize("patient-sidebar", "patient-resize-handle", "left");
        initSidebarCollapse(
          "patient-sidebar",
          "patient-collapse-btn",
          "chevron-left",
          "chevron-right"
        );

        // åˆå§‹åŒ–é€šçŸ¥ä¾§è¾¹æ 
        initSidebarResize(
          "notification-sidebar",
          "notification-resize-handle",
          "right"
        );
        initSidebarCollapse(
          "notification-sidebar",
          "notification-collapse-btn",
          "chevron-right",
          "chevron-left"
        );
      }

      // åˆå§‹åŒ–ä¾§è¾¹æ æ‹–æ‹½è°ƒæ•´å¤§å°åŠŸèƒ½
      function initSidebarResize(sidebarId, handleId, side) {
        const sidebar = document.getElementById(sidebarId);
        const handle = document.getElementById(handleId);
        let isResizing = false;
        let startX = 0;
        let startWidth = 0;

        handle.addEventListener("mousedown", (e) => {
          isResizing = true;
          startX = e.clientX;
          startWidth = parseInt(
            document.defaultView.getComputedStyle(sidebar).width,
            10
          );
          document.body.style.cursor = "col-resize";
          document.body.style.userSelect = "none";
          handle.classList.add("active");
        });

        document.addEventListener("mousemove", (e) => {
          if (!isResizing) return;

          let newWidth;
          if (side === "left") {
            newWidth = startWidth + (e.clientX - startX);
          } else {
            newWidth = startWidth - (e.clientX - startX);
          }

          // é™åˆ¶æœ€å°å’Œæœ€å¤§å®½åº¦
          newWidth = Math.max(60, Math.min(500, newWidth));
          sidebar.style.width = newWidth + "px";
        });

        document.addEventListener("mouseup", () => {
          if (isResizing) {
            isResizing = false;
            document.body.style.cursor = "";
            document.body.style.userSelect = "";
            handle.classList.remove("active");
            saveSidebarSettings();
          }
        });
      }

      // åˆå§‹åŒ–ä¾§è¾¹æ æŠ˜å åŠŸèƒ½
      function initSidebarCollapse(
        sidebarId,
        buttonId,
        expandIcon,
        collapseIcon
      ) {
        const sidebar = document.getElementById(sidebarId);
        const button = document.getElementById(buttonId);
        const icon = button.querySelector("i");

        button.addEventListener("click", (e) => {
          e.preventDefault();
          e.stopPropagation();

          const isCollapsed = sidebar.classList.contains("collapsed");

          if (isCollapsed) {
            // å±•å¼€
            sidebar.classList.remove("collapsed");
            icon.setAttribute("data-lucide", expandIcon);
          } else {
            // æ”¶èµ·
            sidebar.classList.add("collapsed");
            icon.setAttribute("data-lucide", collapseIcon);
          }

          // é‡æ–°åˆå§‹åŒ–å›¾æ ‡
          setTimeout(() => {
            lucide.createIcons();
          }, 100);

          // ä¿å­˜è®¾ç½®
          saveSidebarSettings();
        });

        // æ·»åŠ é¢å¤–çš„ç‚¹å‡»åŒºåŸŸ
        const collapsedIndicator = sidebar.querySelector(
          ".collapsed-indicator"
        );
        const expandHint = sidebar.querySelector(".expand-hint");

        // ç‚¹å‡»æŠ˜å æŒ‡ç¤ºå™¨å±•å¼€
        if (collapsedIndicator) {
          collapsedIndicator.addEventListener("click", (e) => {
            e.stopPropagation();
            if (sidebar.classList.contains("collapsed")) {
              button.click();
            }
          });
        }

        // ç‚¹å‡»å±•å¼€æç¤ºå±•å¼€
        if (expandHint) {
          expandHint.addEventListener("click", (e) => {
            e.stopPropagation();
            if (sidebar.classList.contains("collapsed")) {
              button.click();
            }
          });
        }

        // ç‚¹å‡»ä¾§è¾¹æ ç©ºç™½åŒºåŸŸä¹Ÿå¯ä»¥å±•å¼€
        sidebar.addEventListener("click", (e) => {
          if (
            sidebar.classList.contains("collapsed") &&
            e.target !== button &&
            !button.contains(e.target) &&
            e.target !== collapsedIndicator &&
            e.target !== expandHint
          ) {
            const rect = sidebar.getBoundingClientRect();
            const clickX = e.clientX - rect.left;
            const clickY = e.clientY - rect.top;

            // å¦‚æœç‚¹å‡»åœ¨ä¾§è¾¹æ åŒºåŸŸï¼Œè§¦å‘å±•å¼€
            if (clickX > 5 && clickX < 55 && clickY > 20) {
              button.click();
            }
          }
        });
      }

      // ä¿å­˜ä¾§è¾¹æ è®¾ç½®åˆ°localStorage
      function saveSidebarSettings() {
        const patientSidebar = document.getElementById("patient-sidebar");
        const notificationSidebar = document.getElementById(
          "notification-sidebar"
        );

        const settings = {
          patientWidth: patientSidebar.style.width || "320px",
          patientCollapsed: patientSidebar.classList.contains("collapsed"),
          notificationWidth: notificationSidebar.style.width || "320px",
          notificationCollapsed:
            notificationSidebar.classList.contains("collapsed"),
        };

        localStorage.setItem("sidebar-settings", JSON.stringify(settings));
      }

      // ä»localStorageåŠ è½½ä¾§è¾¹æ è®¾ç½®
      function loadSidebarSettings() {
        try {
          const settings = JSON.parse(
            localStorage.getItem("sidebar-settings") || "{}"
          );
          const patientSidebar = document.getElementById("patient-sidebar");
          const notificationSidebar = document.getElementById(
            "notification-sidebar"
          );

          // æ¢å¤å®½åº¦
          if (settings.patientWidth) {
            patientSidebar.style.width = settings.patientWidth;
          }
          if (settings.notificationWidth) {
            notificationSidebar.style.width = settings.notificationWidth;
          }

          // æ¢å¤æŠ˜å çŠ¶æ€
          if (settings.patientCollapsed) {
            patientSidebar.classList.add("collapsed");
            const patientIcon = document.querySelector(
              "#patient-collapse-btn i"
            );
            patientIcon.setAttribute("data-lucide", "chevron-right");
          }
          if (settings.notificationCollapsed) {
            notificationSidebar.classList.add("collapsed");
            const notificationIcon = document.querySelector(
              "#notification-collapse-btn i"
            );
            notificationIcon.setAttribute("data-lucide", "chevron-left");
          }

          // é‡æ–°åˆå§‹åŒ–å›¾æ ‡
          setTimeout(() => lucide.createIcons(), 100);
        } catch (error) {
          console.error("åŠ è½½ä¾§è¾¹æ è®¾ç½®å¤±è´¥:", error);
        }
      }

      // åˆ‡æ¢æŠ½å±‰çš„æ˜¾ç¤ºçŠ¶æ€
      function toggleDrawer(drawerId) {
        const drawer = document.getElementById(drawerId);
        const toggle = document.querySelector(`[onclick="toggleDrawer('${drawerId}')"]`);
        const icon = toggle.querySelector('i');
        
        drawer.classList.toggle('open');
        toggle.classList.toggle('open');
        
        if (drawer.classList.contains('open')) {
          icon.setAttribute('data-lucide', 'chevron-up');
        } else {
          icon.setAttribute('data-lucide', 'chevron-down');
        }
        
        // é‡æ–°åˆå§‹åŒ–å›¾æ ‡
        lucide.createIcons();
      }

      // ================== ç½‘ç»œä¼ è¾“åŠŸèƒ½ ==================
      
      // åˆå§‹åŒ–ç½‘ç»œè¿æ¥
      // è‡ªåŠ¨æ£€æµ‹æœåŠ¡å™¨åœ°å€
      async function autoDetectServerUrl() {
        console.log('ğŸ” å¼€å§‹è‡ªåŠ¨æ£€æµ‹æœåŠ¡å™¨åœ°å€...');
        
        // é¦–å…ˆå°è¯•å½“å‰é¡µé¢çš„hostï¼ˆå¦‚æœç”¨æˆ·æ˜¯é€šè¿‡æœåŠ¡å™¨è®¿é—®çš„ï¼‰
        const currentHost = window.location.host;
        if (currentHost && currentHost !== 'localhost' && !currentHost.startsWith('127.0.0.1')) {
          const currentUrl = `${window.location.protocol}//${currentHost}`;
          console.log(`ğŸ¯ å°è¯•å½“å‰host: ${currentUrl}`);
          if (await testServerConnection(currentUrl)) {
            return currentUrl;
          }
        }
        
        // è·å–æœ¬æœºå¯èƒ½çš„IPæ®µè¿›è¡Œæµ‹è¯•
        const commonPorts = [3443, 3000];
        const ipRanges = [
          // å¸¸è§çš„å±€åŸŸç½‘IPæ®µ
          '192.168.1', '192.168.0', '192.168.2', '192.168.3', '192.168.4', '192.168.5',
          '10.0.0', '10.0.1', '172.16.0', '172.16.1'
        ];
        
        for (const port of commonPorts) {
          const protocol = port === 3443 ? 'https' : 'http';
          
          for (const ipRange of ipRanges) {
            // æµ‹è¯•ç½‘å…³åœ°å€å’Œå¸¸è§æœåŠ¡å™¨åœ°å€
            const testIPs = [1, 100, 101, 102, 110, 119, 120, 150, 200];
            
            for (const ip of testIPs) {
              const testUrl = `${protocol}://${ipRange}.${ip}:${port}`;
              if (await testServerConnection(testUrl)) {
                return testUrl;
              }
            }
          }
        }
        
        console.log('âŒ æœªæ‰¾åˆ°å¯ç”¨çš„æœåŠ¡å™¨');
        return null;
      }
      
      // æµ‹è¯•æœåŠ¡å™¨è¿æ¥ï¼ˆæ”¹è¿›ç‰ˆï¼‰
      async function testServerConnection(url) {
        try {
          const controller = new AbortController();
          const timeoutId = setTimeout(() => controller.abort(), 3000); // 3ç§’è¶…æ—¶
          
          const response = await fetch(`${url}/status?t=${Date.now()}`, {
            method: 'GET',
            signal: controller.signal,
            cache: 'no-cache',
            headers: {
              'Cache-Control': 'no-cache',
              'Pragma': 'no-cache'
            }
          });
          
          clearTimeout(timeoutId);
          
          if (response.ok) {
            const data = await response.json();
            console.log(`âœ… æ‰¾åˆ°æœåŠ¡å™¨: ${url}`, data);
            return true;
          }
        } catch (error) {
          // é™é»˜å¿½ç•¥é”™è¯¯ï¼Œç»§ç»­å°è¯•ä¸‹ä¸€ä¸ª
          if (error.name !== 'AbortError') {
            console.debug(`æµ‹è¯•è¿æ¥å¤±è´¥ ${url}: ${error.message}`);
          }
        }
        return false;
      }
      
      async function initNetworkConnection() {
        // ä»localStorageåŠ è½½ç½‘ç»œé…ç½®
        const savedConfig = localStorage.getItem('networkConfig');
        if (savedConfig) {
          const config = JSON.parse(savedConfig);
          networkConfig = { ...networkConfig, ...config };
        }
        
        // è‡ªåŠ¨æ£€æµ‹æœåŠ¡å™¨åœ°å€ï¼ˆé¦–æ¬¡å¯åŠ¨æˆ–æ²¡æœ‰æœ‰æ•ˆé…ç½®æ—¶ï¼‰
        if (networkConfig.autoDetection && (!networkConfig.serverUrl || !(await testServerConnection(networkConfig.serverUrl)))) {
          document.getElementById('server-url-input').placeholder = 'æ­£åœ¨è‡ªåŠ¨æ£€æµ‹æœåŠ¡å™¨...';
          updateNetworkStatus('æ£€æµ‹ä¸­...', 'training');
          
          const detectedUrl = await autoDetectServerUrl();
          if (detectedUrl) {
            networkConfig.serverUrl = detectedUrl;
            document.getElementById('server-url-input').value = detectedUrl;
            document.getElementById('server-url-input').placeholder = 'å·²è‡ªåŠ¨æ£€æµ‹åˆ°æœåŠ¡å™¨';
            
            // ä¿å­˜æ£€æµ‹åˆ°çš„é…ç½®
            localStorage.setItem('networkConfig', JSON.stringify(networkConfig));
            
            // è‡ªåŠ¨è¿æ¥
            console.log('ğŸš€ è‡ªåŠ¨è¿æ¥åˆ°æ£€æµ‹åˆ°çš„æœåŠ¡å™¨...');
            setTimeout(() => {
              connectToNetwork();
            }, 500);
          } else {
            document.getElementById('server-url-input').placeholder = 'æœªæ£€æµ‹åˆ°æœåŠ¡å™¨ï¼Œè¯·æ‰‹åŠ¨è¾“å…¥';
            document.getElementById('server-url-input').removeAttribute('readonly');
            updateNetworkStatus('æœªè¿æ¥', 'idle');
          }
        } else {
          // ä½¿ç”¨å·²ä¿å­˜çš„é…ç½®
          document.getElementById('server-url-input').value = networkConfig.serverUrl || '';
          
          // å°è¯•è‡ªåŠ¨è¿æ¥åˆ°ä¸Šæ¬¡çš„æœåŠ¡å™¨
          if (networkConfig.serverUrl) {
            setTimeout(() => {
              connectToNetwork();
            }, 1000);
          } else {
            updateNetworkStatus('æœªè¿æ¥', 'idle');
          }
        }
        
        document.getElementById('auto-sync-toggle').checked = networkConfig.autoSync;
      }
      
      // é‡æ–°æ£€æµ‹æœåŠ¡å™¨ï¼ˆæ”¹è¿›ç‰ˆï¼‰
      async function reDetectServer() {
        try {
          console.log('ğŸ”„ ç”¨æˆ·è§¦å‘é‡æ–°æ£€æµ‹...');
          
          // å…ˆæ¸…ç†ç°æœ‰è¿æ¥
          cleanupConnection();
          
          // é‡ç½®é…ç½®
          networkConfig.serverUrl = '';
          networkConfig.autoDetection = true;
          
          // æ¸…ç©ºè¾“å…¥æ¡†
          const inputElement = document.getElementById('server-url-input');
          if (inputElement) {
            inputElement.value = '';
            inputElement.placeholder = 'æ­£åœ¨é‡æ–°æ£€æµ‹æœåŠ¡å™¨...';
            inputElement.setAttribute('readonly', true);
          }
          
          updateNetworkStatus('é‡æ–°æ£€æµ‹ä¸­...', 'training');
          
          // æ¸…é™¤æµè§ˆå™¨ç¼“å­˜ç›¸å…³çš„å­˜å‚¨
          try {
            localStorage.removeItem('networkConfig');
            sessionStorage.clear();
          } catch (e) {
            console.warn('æ¸…é™¤ç¼“å­˜æ—¶å‡ºç°é—®é¢˜:', e);
          }
          
          const detectedUrl = await autoDetectServerUrl();
          if (detectedUrl) {
            networkConfig.serverUrl = detectedUrl;
            
            if (inputElement) {
              inputElement.value = detectedUrl;
              inputElement.placeholder = 'å·²æ£€æµ‹åˆ°æœåŠ¡å™¨';
            }
            
            // ä¿å­˜æ–°é…ç½®
            localStorage.setItem('networkConfig', JSON.stringify(networkConfig));
            
            // è‡ªåŠ¨è¿æ¥
            console.log('ğŸš€ è‡ªåŠ¨è¿æ¥åˆ°æ–°æ£€æµ‹çš„æœåŠ¡å™¨...');
            setTimeout(() => {
              connectToNetwork();
            }, 1000);
          } else {
            if (inputElement) {
              inputElement.placeholder = 'æœªæ£€æµ‹åˆ°æœåŠ¡å™¨ï¼Œè¯·æ£€æŸ¥ç½‘ç»œ';
              inputElement.removeAttribute('readonly');
            }
            updateNetworkStatus('æ£€æµ‹å¤±è´¥', 'idle');
            alert('æœªæ£€æµ‹åˆ°å¯ç”¨æœåŠ¡å™¨\n\nè¯·æ£€æŸ¥ï¼š\n1. æœåŠ¡å™¨æ˜¯å¦å·²å¯åŠ¨\n2. ç½‘ç»œè¿æ¥æ˜¯å¦æ­£å¸¸\n3. é˜²ç«å¢™è®¾ç½®æ˜¯å¦é˜»æ­¢è¿æ¥');
          }
        } catch (error) {
          console.error('âŒ é‡æ–°æ£€æµ‹è¿‡ç¨‹å‡ºé”™:', error);
          updateNetworkStatus('æ£€æµ‹å¼‚å¸¸', 'idle');
          alert(`é‡æ–°æ£€æµ‹å¤±è´¥: ${error.message}`);
        }
      }
      
      // åˆ‡æ¢ç½‘ç»œè®¾ç½®é¢æ¿
      function toggleNetworkSettings() {
        const panel = document.getElementById('network-settings-panel');
        const isHidden = panel.classList.contains('hidden');
        
        if (isHidden) {
          panel.classList.remove('hidden');
          document.getElementById('server-url-input').focus();
        } else {
          panel.classList.add('hidden');
        }
        
        // é‡æ–°åˆå§‹åŒ–å›¾æ ‡
        setTimeout(() => lucide.createIcons(), 100);
      }
      
      // æµ‹è¯•ç½‘ç»œè¿æ¥
      async function testNetworkConnection() {
        const serverUrl = document.getElementById('server-url-input').value.trim();
        if (!serverUrl) {
          alert('è¯·è¾“å…¥æœåŠ¡å™¨åœ°å€');
          return;
        }
        
        const statusInfo = document.getElementById('network-status-info');
        const indicator = document.getElementById('connection-indicator');
        const statusText = document.getElementById('connection-status-text');
        
        statusInfo.classList.remove('hidden');
        indicator.className = 'status-indicator status-training';
        statusText.textContent = 'æ­£åœ¨æµ‹è¯•è¿æ¥...';
        
        try {
          const response = await fetch(`${serverUrl}/status`, {
            method: 'GET',
            timeout: 5000
          });
          
          if (response.ok) {
            const data = await response.json();
            indicator.className = 'status-indicator status-training';
            statusText.textContent = `è¿æ¥æˆåŠŸï¼æœåŠ¡å™¨æ—¶é—´: ${data.serverTime}`;
            
            setTimeout(() => {
              statusInfo.classList.add('hidden');
            }, 3000);
          } else {
            throw new Error('æœåŠ¡å™¨å“åº”é”™è¯¯');
          }
        } catch (error) {
          console.error('ç½‘ç»œæµ‹è¯•å¤±è´¥:', error);
          indicator.className = 'status-indicator status-idle';
          statusText.textContent = 'è¿æ¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥æœåŠ¡å™¨åœ°å€å’Œç½‘ç»œ';
          
          setTimeout(() => {
            statusInfo.classList.add('hidden');
          }, 3000);
        }
      }
      
      // æµè§ˆå™¨å…¼å®¹æ€§æ£€æŸ¥
      function checkBrowserCompatibility() {
        const userAgent = navigator.userAgent;
        const isEdge = userAgent.includes('Edg/');
        const isChrome = userAgent.includes('Chrome/');
        const isFirefox = userAgent.includes('Firefox/');
        
        console.log(`ğŸŒ æµè§ˆå™¨ä¿¡æ¯: ${userAgent}`);
        console.log(`ğŸ“± æµè§ˆå™¨ç±»å‹: ${isEdge ? 'Edge' : isChrome ? 'Chrome' : isFirefox ? 'Firefox' : 'å…¶ä»–'}`);
        
        // æ£€æŸ¥EventSourceæ”¯æŒ
        if (typeof EventSource === 'undefined') {
          console.error('âŒ æµè§ˆå™¨ä¸æ”¯æŒEventSource');
          return false;
        }
        
        return true;
      }
      
      // æ¸…ç†æ—§è¿æ¥å’Œäº‹ä»¶
      function cleanupConnection() {
        try {
          if (networkConfig.eventSource) {
            console.log('ğŸ§¹ æ¸…ç†ç°æœ‰EventSourceè¿æ¥...');
            networkConfig.eventSource.close();
            networkConfig.eventSource = null;
          }
          networkConfig.connected = false;
          
          // å¼ºåˆ¶åƒåœ¾å›æ”¶ï¼ˆå¦‚æœæ”¯æŒï¼‰
          if (window.gc) {
            window.gc();
          }
        } catch (error) {
          console.warn('æ¸…ç†è¿æ¥æ—¶å‡ºç°é—®é¢˜:', error);
        }
      }
      
      // è¿æ¥åˆ°ç½‘ç»œæœåŠ¡å™¨ï¼ˆæ”¹è¿›ç‰ˆï¼‰
      function connectToNetwork() {
        try {
          console.log('ğŸ”— å¼€å§‹å»ºç«‹ç½‘ç»œè¿æ¥...');
          
          // æ£€æŸ¥æµè§ˆå™¨å…¼å®¹æ€§
          if (!checkBrowserCompatibility()) {
            updateNetworkStatus('æµè§ˆå™¨ä¸å…¼å®¹', 'idle');
            alert('æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒå®æ—¶æ•°æ®åŠŸèƒ½ï¼Œè¯·ä½¿ç”¨Chromeã€Edgeæˆ–Firefoxæœ€æ–°ç‰ˆæœ¬');
            return;
          }
          
          let serverUrl = document.getElementById('server-url-input').value.trim();
          const autoSync = document.getElementById('auto-sync-toggle').checked;
          
          // å¦‚æœæ²¡æœ‰æœåŠ¡å™¨åœ°å€ï¼Œä½¿ç”¨é…ç½®ä¸­çš„åœ°å€
          if (!serverUrl && networkConfig.serverUrl) {
            serverUrl = networkConfig.serverUrl;
            document.getElementById('server-url-input').value = serverUrl;
          }
          
          console.log('ğŸŒ æœåŠ¡å™¨åœ°å€:', serverUrl);
          console.log('ğŸ”„ è‡ªåŠ¨åŒæ­¥:', autoSync);
          
          if (!serverUrl) {
            console.error('âŒ æ²¡æœ‰å¯ç”¨çš„æœåŠ¡å™¨åœ°å€');
            updateNetworkStatus('é…ç½®é”™è¯¯', 'idle');
            alert('è¯·å…ˆè®¾ç½®æœåŠ¡å™¨åœ°å€');
            return;
          }
          
          // æ›´æ–°é…ç½®
          networkConfig.serverUrl = serverUrl;
          networkConfig.autoSync = autoSync;
          
          // ä¿å­˜é…ç½®åˆ°localStorage
          localStorage.setItem('networkConfig', JSON.stringify(networkConfig));
          
          // æ¸…ç†æ—§è¿æ¥
          cleanupConnection();
          
          // å…ˆæµ‹è¯•æœåŠ¡å™¨è¿é€šæ€§
          updateNetworkStatus('æµ‹è¯•è¿æ¥...', 'training');
          
          fetch(`${serverUrl}/status`, {
            method: 'GET',
            cache: 'no-cache',
            headers: {
              'Cache-Control': 'no-cache',
              'Pragma': 'no-cache'
            }
          })
          .then(response => {
            if (!response.ok) {
              throw new Error(`æœåŠ¡å™¨å“åº”é”™è¯¯: ${response.status}`);
            }
            return response.json();
          })
          .then(data => {
            console.log('âœ… æœåŠ¡å™¨è¿é€šæ€§æµ‹è¯•æˆåŠŸ:', data);
            // æœåŠ¡å™¨å¯è¾¾ï¼Œå¼€å§‹å»ºç«‹EventSourceè¿æ¥
            establishEventSourceConnection(serverUrl);
          })
          .catch(error => {
            console.error('âŒ æœåŠ¡å™¨è¿é€šæ€§æµ‹è¯•å¤±è´¥:', error);
            updateNetworkStatus('æœåŠ¡å™¨ä¸å¯è¾¾', 'idle');
            alert(`æ— æ³•è¿æ¥åˆ°æœåŠ¡å™¨: ${error.message}\n\nè¯·æ£€æŸ¥ï¼š\n1. æœåŠ¡å™¨æ˜¯å¦å¯åŠ¨\n2. ç½‘ç»œåœ°å€æ˜¯å¦æ­£ç¡®\n3. é˜²ç«å¢™è®¾ç½®`);
          });
          
        } catch (error) {
          console.error('âŒ è¿æ¥è¿‡ç¨‹å‡ºç°å¼‚å¸¸:', error);
          updateNetworkStatus('è¿æ¥å¼‚å¸¸', 'idle');
          alert(`è¿æ¥è¿‡ç¨‹å‡ºç°é”™è¯¯: ${error.message}`);
        }
      }
      
      // å»ºç«‹EventSourceè¿æ¥
      function establishEventSourceConnection(serverUrl) {
        try {
          updateNetworkStatus('å»ºç«‹å®æ—¶è¿æ¥...', 'training');
          console.log(`ğŸ”„ å»ºç«‹EventSourceè¿æ¥: ${serverUrl}/stream`);
          
          // æ·»åŠ éšæœºå‚æ•°é˜²æ­¢ç¼“å­˜
          const streamUrl = `${serverUrl}/stream?t=${Date.now()}&r=${Math.random()}`;
          networkConfig.eventSource = new EventSource(streamUrl);
          
          // è®¾ç½®è¿æ¥è¶…æ—¶
          const connectionTimeout = setTimeout(() => {
            console.error('âŒ EventSourceè¿æ¥è¶…æ—¶');
            if (networkConfig.eventSource) {
              networkConfig.eventSource.close();
              networkConfig.eventSource = null;
            }
            updateNetworkStatus('è¿æ¥è¶…æ—¶', 'idle');
            alert('è¿æ¥è¶…æ—¶ï¼Œè¯·é‡è¯•æˆ–æ£€æŸ¥ç½‘ç»œ');
          }, 15000); // 15ç§’è¶…æ—¶
          
          networkConfig.eventSource.onopen = function(event) {
            clearTimeout(connectionTimeout);
            networkConfig.connected = true;
            updateNetworkStatus('å·²è¿æ¥', 'training');
            console.log('âœ… EventSourceè¿æ¥å»ºç«‹æˆåŠŸ');
            
            // æ˜¾ç¤ºè¿æ¥æˆåŠŸé€šçŸ¥
            addNotification({
              type: "info",
              patientId: 0,
              patientName: "ç³»ç»Ÿ",
              message: "å±€åŸŸç½‘è¿æ¥å»ºç«‹æˆåŠŸï¼Œå¼€å§‹æ¥æ”¶æ‚£è€…æ•°æ®",
              timestamp: new Date().toLocaleTimeString(),
            });
            
            // å…³é—­è®¾ç½®é¢æ¿
            setTimeout(() => {
              toggleNetworkSettings();
            }, 1000);
          };
          
          networkConfig.eventSource.onmessage = function(event) {
            try {
              const data = JSON.parse(event.data);
              console.log('ğŸ“¨ æ”¶åˆ°EventSourceæ•°æ®:', data);
              
              // å¿½ç•¥å¿ƒè·³åŒ…å’Œåˆå§‹åŒ–æ¶ˆæ¯
              if (data.type === 'heartbeat' || data.type === 'init') {
                return;
              }
              
              handleNetworkData(data);
            } catch (error) {
              console.error('è§£æç½‘ç»œæ•°æ®å¤±è´¥:', error);
            }
          };
          
          networkConfig.eventSource.onerror = function(event) {
            clearTimeout(connectionTimeout);
            console.error('âŒ EventSourceè¿æ¥é”™è¯¯');
            console.error('EventSourceçŠ¶æ€:', networkConfig.eventSource?.readyState);
            console.error('é”™è¯¯äº‹ä»¶:', event);
            
            networkConfig.connected = false;
            
            // æ ¹æ®readyStateåˆ¤æ–­é”™è¯¯ç±»å‹
            if (networkConfig.eventSource) {
              switch (networkConfig.eventSource.readyState) {
                case EventSource.CONNECTING:
                  updateNetworkStatus('è¿æ¥ä¸­æ–­', 'idle');
                  break;
                case EventSource.CLOSED:
                  updateNetworkStatus('è¿æ¥å·²å…³é—­', 'idle');
                  break;
                default:
                  updateNetworkStatus('è¿æ¥é”™è¯¯', 'idle');
              }
            } else {
              updateNetworkStatus('è¿æ¥å¤±è´¥', 'idle');
            }
          };
          
        } catch (error) {
          console.error('âŒ å»ºç«‹EventSourceè¿æ¥å¤±è´¥:', error);
          updateNetworkStatus('è¿æ¥å¤±è´¥', 'idle');
          alert(`å»ºç«‹å®æ—¶è¿æ¥å¤±è´¥: ${error.message}`);
        }
      }
      
      // æ–­å¼€ç½‘ç»œè¿æ¥
      function disconnectFromNetwork() {
        if (networkConfig.eventSource) {
          networkConfig.eventSource.close();
          networkConfig.eventSource = null;
        }
        
        if (networkSyncTimer) {
          clearInterval(networkSyncTimer);
          networkSyncTimer = null;
        }
        
        networkConfig.connected = false;
        updateNetworkStatus('æœªè¿æ¥', 'idle');
        
        // é‡æ–°åˆå§‹åŒ–æ•°æ®æ¥æ”¶å™¨ï¼Œå¯ç”¨æœ¬åœ°ç›‘å¬
        initGameDataReceiver();
        
        console.log('ç½‘ç»œå·²æ–­å¼€ï¼Œæ¢å¤æœ¬åœ°æ•°æ®ç›‘å¬');
      }
      
      // å¯åŠ¨ç½‘ç»œåŒæ­¥ï¼ˆä»…åœ¨SSEä¸å¯ç”¨æ—¶ä½¿ç”¨ï¼‰
      function startNetworkSync() {
        // å¦‚æœå·²ç»æœ‰SSEè¿æ¥ï¼Œä¸å¯åŠ¨è½®è¯¢åŒæ­¥
        if (networkConfig.eventSource && networkConfig.eventSource.readyState === EventSource.OPEN) {
          console.log('å·²æœ‰SSEè¿æ¥ï¼Œè·³è¿‡è½®è¯¢åŒæ­¥');
          return;
        }
        
        if (networkSyncTimer) {
          clearInterval(networkSyncTimer);
        }
        
        networkSyncTimer = setInterval(async () => {
          if (!networkConfig.connected) return;
          
          // å¦‚æœSSEè¿æ¥å·²å»ºç«‹ï¼Œåœæ­¢è½®è¯¢
          if (networkConfig.eventSource && networkConfig.eventSource.readyState === EventSource.OPEN) {
            clearInterval(networkSyncTimer);
            networkSyncTimer = null;
            console.log('SSEè¿æ¥å·²å»ºç«‹ï¼Œåœæ­¢è½®è¯¢åŒæ­¥');
            return;
          }
          
          try {
            const response = await fetch(`${networkConfig.serverUrl}/get-game-data`);
            if (response.ok) {
              const result = await response.json();
              if (result.success && result.data.length > 0) {
                // å¤„ç†æœ€æ–°çš„æ¸¸æˆæ•°æ®ï¼ˆå…è®¸é€šçŸ¥ï¼Œå»é‡é€»è¾‘ä¼šå¤„ç†é‡å¤æ•°æ®ï¼‰
                const latestData = result.data[result.data.length - 1];
                if (latestData) {
                  latestData.source = 'network_poll';
                  handleGameDataUpdate(latestData, false);
                }
              }
            }
          } catch (error) {
            console.error('è½®è¯¢åŒæ­¥æ•°æ®å¤±è´¥:', error);
          }
        }, networkConfig.syncInterval);
        
        console.log('è½®è¯¢åŒæ­¥å·²å¯åŠ¨ï¼Œé—´éš”:', networkConfig.syncInterval / 1000, 'ç§’');
      }
      
      // å¤„ç†ç½‘ç»œæ¥æ”¶çš„æ•°æ®
      function handleNetworkData(data) {
        console.log('æ”¶åˆ°ç½‘ç»œæ•°æ®:', data);
        
        switch (data.type) {
          case 'init':
            console.log('ç½‘ç»œåˆå§‹åŒ–:', data.message);
            break;
            
          case 'game_data':
            // å¤„ç†æ¸¸æˆæ•°æ®ï¼ˆå…è®¸é€šçŸ¥ï¼Œå»é‡é€»è¾‘ä¼šå¤„ç†é‡å¤æ•°æ®ï¼‰
            if (data.data) {
              data.data.source = 'network_sse';
              handleGameDataUpdate(data.data, false);
            }
            break;
            
          case 'data_cleared':
            console.log('æœåŠ¡å™¨æ•°æ®å·²æ¸…ç©º');
            addNotification({
              type: "info",
              patientId: 0,
              patientName: "ç³»ç»Ÿ",
              message: "æœåŠ¡å™¨æ¸¸æˆæ•°æ®å·²æ¸…ç©º",
              timestamp: new Date().toLocaleTimeString(),
            });
            break;
            
          default:
            console.log('æœªçŸ¥æ•°æ®ç±»å‹:', data.type);
        }
      }
      
      // æ›´æ–°ç½‘ç»œçŠ¶æ€æ˜¾ç¤º
      function updateNetworkStatus(text, status) {
        const statusElement = document.getElementById('network-status');
        const textElement = document.getElementById('network-text');
        
        if (statusElement && textElement) {
          statusElement.className = `status-indicator status-${status}`;
          textElement.textContent = text;
        }
      }
      
      // ä¿®æ”¹åŸæœ‰çš„æ¸¸æˆæ•°æ®æ›´æ–°å‡½æ•°ï¼Œæ”¯æŒç½‘ç»œä¼ è¾“
      const originalHandleGameDataUpdate = handleGameDataUpdate;
      handleGameDataUpdate = function(data, skipNotification = false) {
        // è°ƒç”¨åŸæœ‰çš„å¤„ç†é€»è¾‘
        originalHandleGameDataUpdate(data, skipNotification);
        
        // ä»…å½“æ•°æ®æ¥æºæ˜¯æœ¬åœ°ä¸”ç½‘ç»œå·²è¿æ¥æ—¶ï¼Œæ‰åŒæ­¥åˆ°ç½‘ç»œ
        if (networkConfig.connected && 
            (!data.source || data.source === 'local') && 
            data.source !== 'network_sse' && 
            data.source !== 'network_poll') {
          
          // æ ‡è®°æ•°æ®æ¥æºï¼Œé¿å…å¾ªç¯ä¼ è¾“
          const uploadData = { 
            ...data, 
            source: 'local',
            timestamp: new Date().toISOString()
          };
          
          // å¼‚æ­¥å‘é€åˆ°æœåŠ¡å™¨
          fetch(`${networkConfig.serverUrl}/upload-game-data`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify(uploadData)
          }).then(response => response.json())
            .then(result => {
              if (result.success) {
                console.log('âœ… æœ¬åœ°æ•°æ®å·²åŒæ­¥åˆ°ç½‘ç»œ:', result.message);
              }
            })
            .catch(error => {
              console.error('âŒ ç½‘ç»œåŒæ­¥å¤±è´¥:', error);
            });
        }
      };


    </script>
  </body>
</html>
